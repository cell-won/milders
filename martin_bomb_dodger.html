<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Milders Martin Bomb Dodger</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="900" height="700"></canvas>
        
        <div id="connectionStatus" class="loading">ì—°ê²° ì¤‘...</div>
        <div id="score">ì ìˆ˜: 0</div>
        <div id="shieldTimer" class="hidden">ë¬´ì  ì‹¤ë“œ: 0ì´ˆ</div>
        
        <!-- ì‹œì‘ í™”ë©´ -->
        <div id="startScreen" class="ui-overlay">
            <h1 class="game-title" style="line-height: 1.2;">
                <div style="font-size: 0.7em;">Milders</div>
                <div>Martin Bomb Dodger</div>
            </h1>
            <div id="allTimeRecord" class="all-time-record">ğŸ† ì—­ëŒ€ ìµœê³  ê¸°ë¡: ë¡œë”© ì¤‘...</div>
            <div id="gameInstructions">í™”ë©´ì„ í„°ì¹˜í•˜ì—¬ ë°©í–¥ì„ ì „í™˜í•˜ë©° í­íƒ„ì„ í”¼í•˜ì„¸ìš”!</div>
            <img id="startButtonImage" src="startbutton.png" alt="ê²Œì„ ì‹œì‘" onclick="startGame()">
            
            <div id="rankingSection">
                <div id="rankingList">
                    <h3>TOP 3 ë­í‚¹</h3>
                    <div id="top3Rankings">ë¡œë”© ì¤‘...</div>
                </div>
                
                <div id="rankingControls">
                    <h3>ë‚´ ìˆœìœ„ í™•ì¸</h3>
                    <div class="input-row">
                        <input type="text" id="checkNickname" placeholder="ë‹‰ë„¤ì„" maxlength="20" autocomplete="off">
                        <input type="password" id="checkPin" placeholder="PIN (6ìë¦¬)" maxlength="6" pattern="[0-9]{6}" inputmode="numeric">
                    </div>
                    <button class="secondary" onclick="checkMyRanking()">ë‚´ ìˆœìœ„ ë³´ê¸°</button>
                    <div id="myRankDisplay"></div>
                </div>
            </div>
        </div>
        
        <!-- ê²Œì„ì˜¤ë²„ í™”ë©´ -->
        <div id="gameOverScreen" class="ui-overlay hidden">
            <img src="gameover.png" alt="ê²Œì„ ì˜¤ë²„" style="max-width: 250px; margin: 20px;">
            <p id="finalScore">ìµœì¢… ì ìˆ˜: 0</p>
            <div id="nameInputSection" class="hidden">
                <input type="text" id="playerName" placeholder="ë‹‰ë„¤ì„ (ê³µê°œ)" maxlength="20" autocomplete="off">
                <input type="password" id="playerPin" placeholder="ê°œì¸í™•ì¸ë²ˆí˜¸ (6ìë¦¬)" maxlength="6" pattern="[0-9]{6}" inputmode="numeric">
                <p style="font-size: 12px; color: #ccc;">* ê°œì¸í™•ì¸ë²ˆí˜¸ëŠ” 6ìë¦¬ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”</p>
                <br>
                <button onclick="submitScore()">ë­í‚¹ ë“±ë¡</button>
                <div id="submitMessage"></div>
            </div>
            <!-- ê²Œì„ ì¢…ë£Œ ë²„íŠ¼ë“¤ (ë­í‚¹ ë“±ë¡ ì¤‘ì¼ ë•ŒëŠ” ìˆ¨ê¹€) -->
            <div id="gameEndButtons">
                <button onclick="restartGame()">ë‹¤ì‹œ ì‹œì‘</button>
                <button onclick="showStartScreen()">ë©”ì¸ ë©”ë‰´</button>
            </div>
        </div>

        <!-- ìƒìœ„ 10ìœ„ ë­í‚¹ í™•ì¸ ëª¨ë‹¬ -->
        <div id="rankCheckModal" class="rank-check-modal hidden">
            <div class="rank-check-content">
                <div class="rank-check-title">ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰</div>
                <div class="rank-check-message" id="rankCheckMessage">
                    ìƒìœ„ 10ìœ„ ì•ˆì— ì§„ì…í–ˆìŠµë‹ˆë‹¤!<br>
                    ë­í‚¹ì— ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                </div>
                <div class="rank-check-buttons">
                    <button onclick="proceedToRankingRegistration()">ë­í‚¹ ë“±ë¡í•˜ê¸°</button>
                    <button class="secondary" onclick="skipRankingRegistration()">ê±´ë„ˆë›°ê¸°</button>
                </div>
            </div>
        </div>

        <!-- ê´€ë¦¬ì ëª¨ë‹¬ -->
        <div id="adminModal" class="admin-modal hidden">
            <div class="admin-content">
                <h2>ê´€ë¦¬ì ëª¨ë“œ</h2>
                
                <div class="admin-tabs">
                    <div class="admin-tab active" onclick="switchAdminTab('ranking')">ë­í‚¹ ê´€ë¦¬</div>
                    <div class="admin-tab" onclick="switchAdminTab('notice')">ê³µì§€ì‚¬í•­ ê´€ë¦¬</div>
                </div>
                
                <!-- ë­í‚¹ ê´€ë¦¬ íƒ­ -->
                <div id="ranking-tab" class="admin-tab-content active">
                    <p>ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    <br>
                    <button class="danger" onclick="resetRankings()">ë­í‚¹ ì´ˆê¸°í™”</button>
                    <button class="warning" onclick="viewBackupData()">ë°±ì—… ê¸°ë¡ ë³´ê¸°</button>
                    <div id="adminMessage"></div>
                    <div id="backupDisplay"></div>
                </div>
                
                <!-- ê³µì§€ì‚¬í•­ ê´€ë¦¬ íƒ­ -->
                <div id="notice-tab" class="admin-tab-content">
                    <h3>ìƒˆ ê³µì§€ì‚¬í•­ ì‘ì„±</h3>
                    <div class="notice-form">
                        <input type="text" id="noticeTitle" placeholder="ê³µì§€ì‚¬í•­ ì œëª©" maxlength="100">
                        <textarea id="noticeContent" placeholder="ê³µì§€ì‚¬í•­ ë‚´ìš©" rows="5" maxlength="1000"></textarea>
                        <input type="date" id="noticeExpireDate" placeholder="ê³µì§€ ê²Œì‹œ ë§ˆê° ê¸°ê°„" title="ë§Œë£Œì¼ (ì„ íƒì‚¬í•­)">
                        <div style="display: flex; gap: 10px;">
                            <button onclick="saveNotice()">ê³µì§€ì‚¬í•­ ì €ì¥</button>
                            <button class="secondary" onclick="clearNoticeForm()">ì´ˆê¸°í™”</button>
                        </div>
                        <div id="noticeMessage"></div>
                    </div>
                    
                    <hr style="margin: 30px 0;">
                    
                    <h3>ê¸°ì¡´ ê³µì§€ì‚¬í•­ ê´€ë¦¬</h3>
                    <div id="noticeList">ë¡œë”© ì¤‘...</div>
                </div>
                
                <br>
                <button class="secondary" onclick="closeAdminModal()">ë‹«ê¸°</button>
            </div>
        </div>

        <!-- ê³µì§€ì‚¬í•­ í‘œì‹œ ëª¨ë‹¬ -->
        <div id="noticeModal" class="notice-modal hidden">
            <div class="notice-content">
                <div class="notice-title" id="noticeModalTitle"></div>
                <div class="notice-body" id="noticeModalContent"></div>
                <div class="notice-actions">
                    <div class="notice-checkbox">
                        <input type="checkbox" id="dontShowToday">
                        <label for="dontShowToday">ì˜¤ëŠ˜ í•˜ë£¨ ë³´ì§€ ì•Šê¸°</label>
                    </div>
                    <button onclick="closeNoticeModal()">í™•ì¸</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ë°©ë¬¸ì ì¹´ìš´í„° -->
    <div class="visitor-counter" id="visitorCounter">
        <span id="visitorCount">ë°©ë¬¸ì: ë¡œë”©ì¤‘...</span>
    </div>

<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 100%);
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #gameContainer {
            position: relative;
            border: 3px solid #333;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            background: #000;
        }

        /* ë°ìŠ¤í¬íƒ‘ ìµœì í™” */
        @media (min-width: 769px) {
            #gameContainer {
                width: 900px;
                height: 700px;
            }
            
            #gameCanvas {
                width: 900px;
                height: 700px;
            }
            
            .ui-overlay {
                font-size: 22px;
                padding: 15px;
            }
            
            .game-title {
                font-size: 38px;
                margin-bottom: 12px;
            }
            
            .all-time-record {
                font-size: 15px;
                margin-bottom: 20px;
            }
            
            button {
                padding: 15px 30px;
                font-size: 18px;
                margin: 10px;
            }
            
            input {
                padding: 12px;
                font-size: 16px;
                width: 200px;
                margin: 8px;
            }
            
            #rankingSection {
                flex-direction: row;
                gap: 25px;
            }
            
            #score {
                font-size: 32px;
                top: 20px;
                left: 20px;
            }

            #shieldTimer {
                font-size: 20px;
                top: 70px;
                left: 20px;
            }

            #startButtonImage {
                max-width: 180px;
                margin: 15px;
            }

            #gameInstructions {
                font-size: 16px;
                margin: 10px 0;
            }

            /* ê´€ë¦¬ì ëª¨ë‹¬ ì…ë ¥ì°½ í¬ê¸° í™•ëŒ€ */
            .notice-form input, .notice-form textarea {
                width: 100% !important;
                max-width: 500px !important;
                padding: 15px !important;
                font-size: 16px !important;
            }
        }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            body {
                margin: 0;
                padding: 0;
                position: fixed;
                width: 100%;
                height: 100%;
                align-items: stretch;
                justify-content: stretch;
            }
            
            #gameContainer {
                width: 100vw;
                height: 100vh;
                height: calc(var(--vh, 1vh) * 100);
                border-radius: 0;
                border: none;
                max-width: 100vw;
                max-height: 100vh;
                position: relative;
            }
            
            #gameCanvas {
                width: 100vw;
                height: 100vh;
                height: calc(var(--vh, 1vh) * 100);
                max-width: 100vw;
                max-height: 100vh;
                display: block;
                position: absolute;
                top: 0;
                left: 0;
            }
            
            .ui-overlay {
                font-size: 15px;
                padding: 12px 8px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                height: calc(var(--vh, 1vh) * 100);
                max-width: 100vw;
                max-height: 100vh;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .ui-overlay::-webkit-scrollbar {
                display: none;
            }
            
            .game-title {
                font-size: clamp(32px, 9vw, 45px);
                margin-bottom: 6px;
                text-align: center;
            }

            .all-time-record {
                font-size: clamp(11px, 3vw, 13px);
                margin-bottom: 12px;
                text-align: center;
                padding: 6px 12px;
            }
            
            button {
                padding: 12px 18px;
                font-size: 13px;
                margin: 5px 3px;
                min-height: 42px;
                border-radius: 8px;
                min-width: 90px;
                width: auto;
            }
            
            input, textarea {
                padding: 12px;
                font-size: 13px;
                width: calc(50% - 5px);
                max-width: 130px;
                margin: 5px 2px;
                border-radius: 8px;
                border: 2px solid #ccc;
            }
            
            #rankingSection {
                flex-direction: column;
                gap: 12px;
                width: 100%;
                align-items: center;
                max-width: 100%;
            }
            
            #rankingList, #rankingControls {
                width: calc(100% - 16px);
                max-width: 300px;
                margin: 0 auto;
                padding: 12px;
            }

            #rankingControls {
                padding: 10px;
            }

            #rankingControls h3 {
                font-size: 15px;
                margin-bottom: 6px;
            }

            #rankingControls .input-row {
                display: flex;
                gap: 4px;
                margin-bottom: 6px;
                align-items: center;
            }

            #rankingControls button {
                padding: 10px 14px;
                font-size: 12px;
                min-width: 70px;
                margin: 0;
            }
            
            #score {
                font-size: clamp(16px, 4vw, 22px);
                position: fixed;
                top: env(safe-area-inset-top, 15px);
                left: 15px;
                z-index: 1000;
                max-width: calc(100vw - 30px);
            }

            #shieldTimer {
                font-size: clamp(13px, 3.2vw, 17px);
                position: fixed;
                top: calc(env(safe-area-inset-top, 15px) + 32px);
                left: 15px;
                z-index: 1000;
                max-width: calc(100vw - 30px);
            }
            
            #connectionStatus {
                position: fixed;
                top: env(safe-area-inset-top, 15px);
                right: 15px;
                font-size: 10px;
                padding: 3px 6px;
                z-index: 1000;
                max-width: 100px;
            }

            #startButtonImage {
                max-width: 120px;
                margin: 10px;
            }

            #gameInstructions {
                font-size: 13px;
                margin: 8px 0;
                padding: 0 10px;
                text-align: center;
            }

            /* ëª¨ë°”ì¼ ê´€ë¦¬ì ëª¨ë‹¬ ì…ë ¥ì°½ í¬ê¸° í™•ëŒ€ */
            .notice-form input, .notice-form textarea {
                width: calc(100% - 10px) !important;
                max-width: 400px !important;
                padding: 16px !important;
                font-size: 14px !important;
            }
        }

        #gameCanvas {
            display: block;
            cursor: pointer;
            touch-action: manipulation;
        }

        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.8);
            color: white;
            text-align: center;
            z-index: 100;
        }

        .hidden {
            display: none !important;
        }

        button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border: none;
            color: white;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            -webkit-appearance: none;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: linear-gradient(135deg, #2196F3, #1976D2);
        }

        button.danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }

        button.warning {
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }

        #rankingSection {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            width: 100%;
        }

        #rankingList, #rankingControls {
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 18px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .rank-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 6px;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .rank-item:hover {
            background: rgba(255,215,0,0.1);
            transform: translateX(5px);
        }

        .rank-item.top3 {
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            padding: 12px 8px;
            margin: 6px 0;
            border-radius: 8px;
            color: #333;
            border: none;
            box-shadow: 0 4px 8px rgba(255,215,0,0.3);
        }

        #score, #shieldTimer {
            position: absolute;
            color: white;
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            z-index: 10;
            background: rgba(0,0,0,0.5);
            padding: 6px 12px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
        }

        #shieldTimer {
            background: rgba(255, 140, 0, 0.8);
            color: white;
            animation: shieldPulse 1s infinite;
        }

        @keyframes shieldPulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        /* í”Œë¡œíŒ… í…ìŠ¤íŠ¸ ì• ë‹ˆë©”ì´ì…˜ CSS */
        .floating-text {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            pointer-events: none;
            z-index: 999;
            animation: floatUp 1.5s ease-out forwards;
        }

        .floating-text.positive {
            color: #ff4444;
        }

        .floating-text.negative {
            color: #4444ff;
        }

        .floating-text.shield {
            color: #ff8c00;
            font-size: 20px;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0px) scale(1);
            }
            50% {
                opacity: 1;
                transform: translateY(-30px) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translateY(-60px) scale(0.8);
            }
        }

        /* ì•„ì´í…œ ìˆ˜ì§‘ íŒŒí‹°í´ íš¨ê³¼ */
        .item-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 998;
            animation: particleExplosion 0.8s ease-out forwards;
        }

        .item-particle.bomb {
            background: #ff4444;
        }

        .item-particle.item1 {
            background: #ff8800;
        }

        .item-particle.item2 {
            background: #4488ff;
        }

        .item-particle.shield {
            background: #ff8c00;
        }

        @keyframes particleExplosion {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0) translateY(-40px);
            }
        }

        /* ë¬´ì ì‹¤ë“œ ê°•í™”ëœ ì‹œê° íš¨ê³¼ */
        .shield-effect {
            position: absolute;
            border: 4px solid rgba(255, 140, 0, 0.8);
            border-radius: 50%;
            animation: shieldGlow 0.3s ease-out;
            pointer-events: none;
            z-index: 997;
        }

        @keyframes shieldGlow {
            0% {
                transform: scale(0.5);
                opacity: 1;
                border-width: 8px;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
                border-width: 2px;
            }
        }

        input[type="text"], input[type="password"], input[type="date"], textarea {
            border: 2px solid #ddd;
            background: rgba(255,255,255,0.9);
            color: #333;
            outline: none;
            transition: all 0.3s ease;
            -webkit-appearance: none;
        }

        input:focus, textarea:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 10px rgba(76,175,80,0.3);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        #startButtonImage {
            cursor: pointer;
            transition: transform 0.3s ease;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }

        #startButtonImage:hover {
            transform: scale(1.05);
        }

        .game-title {
            font-weight: bold;
            color: #FFD700;
            text-shadow: 4px 4px 8px rgba(0,0,0,0.8);
            background: linear-gradient(45deg, #FFD700, #FFA500);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .all-time-record {
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
            border: 2px solid #FFD700;
            border-radius: 8px;
            background: rgba(255, 215, 0, 0.1);
            backdrop-filter: blur(5px);
            font-weight: bold;
        }

        #connectionStatus {
            position: absolute;
            padding: 4px 8px;
            border-radius: 15px;
            font-weight: bold;
            backdrop-filter: blur(5px);
        }

        .online {
            background: rgba(76,175,80,0.9);
            color: white;
        }

        .offline {
            background: rgba(244,67,54,0.9);
            color: white;
        }

        .loading {
            background: rgba(255,152,0,0.9);
            color: white;
        }

        .error-message {
            color: #f44336;
            font-size: 13px;
            margin: 8px 0;
            padding: 8px;
            background: rgba(244,67,54,0.1);
            border-radius: 5px;
        }

        .success-message {
            color: #4CAF50;
            font-size: 13px;
            margin: 8px 0;
            padding: 8px;
            background: rgba(76,175,80,0.1);
            border-radius: 5px;
        }

        /* ê´€ë¦¬ì ëª¨ë‹¬ */
        .admin-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .admin-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            color: #333;
        }

        .backup-item {
            padding: 8px;
            margin: 4px 0;
            background: rgba(0,0,0,0.05);
            border-radius: 5px;
            border-left: 4px solid #2196F3;
            font-size: 14px;
        }

        /* ê³µì§€ì‚¬í•­ ëª¨ë‹¬ */
        .notice-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .notice-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            color: #333;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .notice-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 8px;
        }

        .notice-body {
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 15px;
            white-space: pre-wrap;
        }

        .notice-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .notice-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #666;
        }

        /* ê´€ë¦¬ì ê³µì§€ì‚¬í•­ ê´€ë¦¬ */
        .admin-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        .admin-tab {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .admin-tab.active {
            border-bottom-color: #4CAF50;
            color: #4CAF50;
            font-weight: bold;
        }

        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        .notice-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .notice-item {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 8px;
            position: relative;
            font-size: 14px;
        }

        .notice-item.expired {
            opacity: 0.6;
            background: #f5f5f5;
        }

        .notice-item-title {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .notice-item-meta {
            font-size: 11px;
            color: #666;
            margin-bottom: 8px;
        }

        .notice-item-actions {
            position: absolute;
            top: 8px;
            right: 8px;
        }

        /* ë°©ë¬¸ì ì¹´ìš´í„° */
        .visitor-counter {
            position: fixed;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            z-index: 1000;
            backdrop-filter: blur(5px);
            transition: opacity 0.3s ease;
        }

        .visitor-counter.game-playing {
            opacity: 0;
            pointer-events: none;
        }

        /* ìƒìœ„ 10ìœ„ í™•ì¸ ëª¨ë‹¬ */
        .rank-check-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1500;
        }

        .rank-check-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            max-width: 90%;
            color: #333;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .rank-check-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #FFD700;
        }

        .rank-check-message {
            font-size: 16px;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .rank-check-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* iOS ìŠ¤íƒ€ì¼ ì ìš© */
        @supports (-webkit-touch-callout: none) {
            input, textarea {
                -webkit-appearance: none;
                border-radius: 10px;
            }
            
            button {
                -webkit-appearance: none;
            }
        }
    </style>

<!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, where, getDocs, deleteDoc, doc, updateDoc, increment, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBHUAQuZ-JeNmpeDfdbo5kPwW7v2emH8bg",
            authDomain: "milders-flappy-martin.firebaseapp.com",
            projectId: "milders-flappy-martin",
            storageBucket: "milders-flappy-martin.firebasestorage.app",
            messagingSenderId: "505347834080",
            appId: "1:505347834080:web:c10bcf079e1681ffd19085"
        };

        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            window.firebaseDB = db;
            window.firestoreModules = { collection, addDoc, query, orderBy, limit, onSnapshot, where, getDocs, deleteDoc, doc, updateDoc, increment, setDoc, getDoc };
            window.firebaseAuth = getAuth(app);
            window.authModules = { signInWithEmailAndPassword, signOut };
            console.log("Firebase ì—°ê²° ì„±ê³µ!");
        } catch (error) {
            console.error("Firebase ì—°ê²° ì‹¤íŒ¨:", error);
            window.firebaseDB = null;
        }
    </script>

<script>
        // Martin Bomb Dodgerìš© ë””ë°”ì´ìŠ¤ë³„ ê²Œì„ ì„¤ì •
        const DEVICE_CONFIGS = {
            mobile: {
                gameSpeed: 2.0,           // ê¸°ë³¸ ë–¨ì–´ì§€ëŠ” ì†ë„
                moveSpeed: 5.0,           // ì¢Œìš° ì´ë™ ì†ë„
                bombInterval: 60,         // í­íƒ„ ìƒì„± ê°„ê²© (ì£¼ìš”)
                bonusInterval: 200,       // ë³´ë„ˆìŠ¤ ì•„ì´í…œ ìƒì„± ê°„ê²© (ë¶€ê°€)
                bombProbability: 0.8,     // í­íƒ„ ìƒì„± í™•ë¥  (80%)
                bonusItemProbability: 0.3,// ë³´ë„ˆìŠ¤ ì•„ì´í…œ ìƒì„± í™•ë¥  (30%)
                characterSize: 50,        // ìºë¦­í„° í¬ê¸°
                itemSize: 40,             // ì•„ì´í…œ í¬ê¸°
                itemSpeedVariation: 0.3,  // ì•„ì´í…œ ì†ë„ ë³€í™”
                spawnWidth: 0.8,          // ìƒì„± êµ¬ì—­ í­ (í™”ë©´ ëŒ€ë¹„)
                speedIncrease: 0.15,      // ë‚œì´ë„ë³„ ì†ë„ ì¦ê°€ëŸ‰
                intervalDecrease: 3       // ë‚œì´ë„ë³„ ìƒì„±ê°„ê²© ê°ì†ŒëŸ‰
            },
            desktop: {
                gameSpeed: 2.5,
                moveSpeed: 6.0,
                bombInterval: 50,
                bonusInterval: 180,
                bombProbability: 0.8,
                bonusItemProbability: 0.35,
                characterSize: 45,
                itemSize: 35,
                itemSpeedVariation: 0.4,
                spawnWidth: 0.8,
                speedIncrease: 0.2,
                intervalDecrease: 4
            }
        };

        // ë³´ë„ˆìŠ¤ ì•„ì´í…œ íƒ€ì… ë° í™•ë¥  ì •ì˜ (bomb ì œì™¸)
        const BONUS_ITEM_TYPES = ['item1', 'item2', 'shield'];
        const BONUS_ITEM_PROBABILITIES = {
            item1: 0.5,   // 50%
            item2: 0.3,   // 30%
            shield: 0.2   // 20%
        };

        // í™•ë¥  ê¸°ë°˜ ë³´ë„ˆìŠ¤ ì•„ì´í…œ ì„ íƒ í•¨ìˆ˜
        function selectRandomBonusItem() {
            const random = Math.random();
            let cumulative = 0;
            
            for (const itemType of BONUS_ITEM_TYPES) {
                cumulative += BONUS_ITEM_PROBABILITIES[itemType];
                if (random < cumulative) {
                    return itemType;
                }
            }
            
            return 'item1'; // ê¸°ë³¸ê°’
        }
        
        // ê²Œì„ ê¸°ë³¸ ì„¤ì •
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let gameState = 'start';
        let score = 0;
        let gameSpeed = 2.9;
        let difficultyLevel = 1;
        let currentNoticeIndex = 0;
        let pendingNotices = [];
        
        // ë¶„ë¦¬ëœ ì•„ì´í…œ ì‹œìŠ¤í…œ ë³€ìˆ˜ (ê²Œì„ ì‹œì‘ì— í•„ìˆ˜)
        let bombs = [];           // í­íƒ„ë§Œ ì €ì¥
        let bonusItems = [];      // ë³´ë„ˆìŠ¤ ì•„ì´í…œë§Œ ì €ì¥
        let bombTimer = 0;        // í­íƒ„ ìƒì„± íƒ€ì´ë¨¸
        let bonusTimer = 0;       // ë³´ë„ˆìŠ¤ ì•„ì´í…œ ìƒì„± íƒ€ì´ë¨¸
        
        // ë¬´ì  ì‹¤ë“œ ì‹œìŠ¤í…œ ë³€ìˆ˜
        let isInvulnerable = false;
        let invulnerabilityTimer = 0;
        let invulnerabilityDuration = 5000; // 5ì´ˆ
        
        // ì—­ëŒ€ ìµœê³  ê¸°ë¡ ë³€ìˆ˜ (ê¸°ë³¸ê°’ ì„¤ì •)
        let allTimeRecord = {
            score: 0,
            nickname: 'ì•„ì§ ì—†ìŒ',
            device: 'unknown',
            date: ''
        };
        
        // ë””ë°”ì´ìŠ¤ ê°ì§€
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
        let currentConfig = isMobile ? DEVICE_CONFIGS.mobile : DEVICE_CONFIGS.desktop;
        
        // ëª¨ë°”ì¼ ë·°í¬íŠ¸ ì„¤ì •
        function setVH() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        function setupCanvas() {
            if (isMobile) {
                setVH();
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                canvas.style.touchAction = 'manipulation';
            } else {
                canvas.width = 900;
                canvas.height = 700;
            }
        }
        
        setupCanvas();
        
        // ìºë¦­í„° ì´ë™ ì„¤ì • (ì¤‘ë ¥ ì œê±°, ì¢Œìš° ì´ë™ë§Œ)
        let MOVE_SPEED = currentConfig.moveSpeed;
        
        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(status, text) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = status;
            statusEl.textContent = text;
        }
        
        // ì•”í˜¸í™” í•¨ìˆ˜
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString().slice(0, 6);
        }

        // ê´€ë¦¬ì ì¸ì¦ í•¨ìˆ˜
        async function adminLogin() {
            try {
                const { signInWithEmailAndPassword } = window.authModules;
                const userCredential = await signInWithEmailAndPassword(window.firebaseAuth, 'milders@milders.com', '021502');
                
                // í† í° ê°•ì œ ê°±ì‹ 
                await userCredential.user.getIdToken(true);
                
                console.log('ê´€ë¦¬ì ì¸ì¦ ì„±ê³µ + í† í° ê°±ì‹ ');
                document.getElementById('adminModal').classList.remove('hidden');
            } catch (error) {
                console.error('ê´€ë¦¬ì ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
                alert('ê´€ë¦¬ì ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê°•í™”ëœ ì—­ëŒ€ ìµœê³  ê¸°ë¡ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        async function loadAllTimeRecord() {
            const maxRetries = 3;
            let currentRetry = 0;
            
            if (!window.firebaseDB) {
                console.log('Firebase ì—°ê²° ì—†ìŒ - ì—­ëŒ€ ê¸°ë¡ ë¡œë“œ ë¶ˆê°€');
                setDefaultRecord('ì—°ê²° í•„ìš”');
                return;
            }
            
            while (currentRetry < maxRetries) {
                try {
                    console.log(`ì—­ëŒ€ ê¸°ë¡ ë¡œë“œ ì‹œë„ ${currentRetry + 1}/${maxRetries}`);
                    
                    const { doc, getDoc, setDoc } = window.firestoreModules;
                    const recordRef = doc(window.firebaseDB, 'all_time_record_dodger', 'global'); // dodgerìš© ë³„ë„ ê¸°ë¡
                    
                    const recordDoc = await getDoc(recordRef);
                    
                    if (recordDoc.exists()) {
                        const data = recordDoc.data();
                        allTimeRecord = data;
                        const deviceIcon = data.device === 'mobile' ? 'ğŸ“±' : 'ğŸ’»';
                        document.getElementById('allTimeRecord').textContent = 
                            `ğŸ† ì—­ëŒ€ ìµœê³  ê¸°ë¡: ${data.nickname} ${deviceIcon} - ${data.score}ì  (${data.date})`;
                        console.log('ì—­ëŒ€ ìµœê³  ê¸°ë¡ ë¡œë“œ ì„±ê³µ:', data);
                        return;
                    } else {
                        console.log('ì—­ëŒ€ ê¸°ë¡ ë¬¸ì„œ ì—†ìŒ, ê¸°ë³¸ ë¬¸ì„œ ìƒì„± ì‹œë„');
                        await createDefaultRecord(recordRef, setDoc);
                        return;
                    }
                    
                } catch (error) {
                    console.error(`ì—­ëŒ€ ê¸°ë¡ ë¡œë“œ ì‹œë„ ${currentRetry + 1} ì‹¤íŒ¨:`, error);
                    currentRetry++;
                    
                    if (currentRetry < maxRetries) {
                        console.log(`${1000 * currentRetry}ms í›„ ì¬ì‹œë„...`);
                        await new Promise(resolve => setTimeout(resolve, 1000 * currentRetry));
                    }
                }
            }
            
            console.error('ì—­ëŒ€ ê¸°ë¡ ë¡œë“œ ìµœì¢… ì‹¤íŒ¨ - ê¸°ë³¸ê°’ ì‚¬ìš©');
            setDefaultRecord('ë¡œë“œ ì‹¤íŒ¨');
        }

        async function createDefaultRecord(recordRef, setDoc) {
            const defaultRecord = {
                score: 0,
                nickname: 'ì•„ì§ ì—†ìŒ',
                device: 'unknown',
                date: new Date().toLocaleDateString('ko-KR'),
                timestamp: Date.now()
            };
            
            try {
                await setDoc(recordRef, defaultRecord);
                allTimeRecord = defaultRecord;
                document.getElementById('allTimeRecord').textContent = 'ğŸ† ì—­ëŒ€ ìµœê³  ê¸°ë¡: ì•„ì§ ê¸°ë¡ ì—†ìŒ';
                console.log('ê¸°ë³¸ ì—­ëŒ€ ê¸°ë¡ ë¬¸ì„œ ìƒì„± ì™„ë£Œ');
            } catch (writeError) {
                console.error('ê¸°ë³¸ ë¬¸ì„œ ìƒì„± ì‹¤íŒ¨:', writeError);
                throw writeError;
            }
        }

        function setDefaultRecord(reason) {
            allTimeRecord = {
                score: 0,
                nickname: reason === 'ì—°ê²° í•„ìš”' ? 'ì—°ê²° í•„ìš”' : 'ì˜¤ë¥˜',
                device: 'unknown',
                date: ''
            };
            document.getElementById('allTimeRecord').textContent = `ğŸ† ì—­ëŒ€ ìµœê³  ê¸°ë¡: ${reason}`;
        }

        async function updateAllTimeRecord(newScore, nickname, device) {
            if (!window.firebaseDB || newScore <= allTimeRecord.score) return;
            
            const maxRetries = 2;
            let currentRetry = 0;
            
            while (currentRetry < maxRetries) {
                try {
                    const { doc, setDoc } = window.firestoreModules;
                    const newRecord = {
                        score: newScore,
                        nickname: nickname,
                        device: device,
                        date: new Date().toLocaleDateString('ko-KR'),
                        timestamp: Date.now()
                    };
                    
                    await setDoc(doc(window.firebaseDB, 'all_time_record_dodger', 'global'), newRecord);
                    allTimeRecord = newRecord;
                    
                    const deviceIcon = device === 'mobile' ? 'ğŸ“±' : 'ğŸ’»';
                    document.getElementById('allTimeRecord').textContent = 
                        `ğŸ† ì—­ëŒ€ ìµœê³  ê¸°ë¡: ${nickname} ${deviceIcon} - ${newScore}ì  (${newRecord.date})`;
                    
                    console.log('ì‹ ê¸°ë¡ ê°±ì‹  ì„±ê³µ:', newRecord);
                    return;
                    
                } catch (error) {
                    console.error(`ì‹ ê¸°ë¡ ì €ì¥ ì‹œë„ ${currentRetry + 1} ì‹¤íŒ¨:`, error);
                    currentRetry++;
                    
                    if (currentRetry < maxRetries) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
            }
            
            console.error('ì‹ ê¸°ë¡ ì €ì¥ ìµœì¢… ì‹¤íŒ¨');
        }

        // ë¬´ì  ì‹¤ë“œ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        function activateInvulnerability() {
            isInvulnerable = true;
            invulnerabilityTimer = invulnerabilityDuration;
            document.getElementById('shieldTimer').classList.remove('hidden');
            
            // ë¬´ì ì‹¤ë“œ í™œì„±í™” ì‹œê°ì  íš¨ê³¼ ê°•í™”
            showShieldActivationEffect();
            console.log('ë¬´ì  ì‹¤ë“œ í™œì„±í™”! 5ì´ˆê°„ ì§€ì†');
        }

        function updateInvulnerability(deltaTime) {
            if (!isInvulnerable) return;
            
            invulnerabilityTimer -= deltaTime;
            const secondsLeft = Math.ceil(invulnerabilityTimer / 1000);
            document.getElementById('shieldTimer').textContent = `ë¬´ì  ì‹¤ë“œ: ${secondsLeft}ì´ˆ`;
            
            if (invulnerabilityTimer <= 0) {
                deactivateInvulnerability();
            }
        }

        function deactivateInvulnerability() {
            isInvulnerable = false;
            invulnerabilityTimer = 0;
            document.getElementById('shieldTimer').classList.add('hidden');
            console.log('ë¬´ì  ì‹¤ë“œ ì¢…ë£Œ');
        }

        // ìƒˆë¡œìš´ ì‹œê°ì  íš¨ê³¼ í•¨ìˆ˜ë“¤
        function showFloatingText(x, y, text, type) {
            const canvas = document.getElementById('gameCanvas');
            const rect = canvas.getBoundingClientRect();
            
            // ìº”ë²„ìŠ¤ ì¢Œí‘œë¥¼ í™”ë©´ ì¢Œí‘œë¡œ ë³€í™˜
            const screenX = rect.left + (x * rect.width / canvas.width);
            const screenY = rect.top + (y * rect.height / canvas.height);
            
            const floatingText = document.createElement('div');
            floatingText.className = `floating-text ${type}`;
            floatingText.textContent = text;
            floatingText.style.left = screenX + 'px';
            floatingText.style.top = screenY + 'px';
            
            document.body.appendChild(floatingText);
            
            // 1.5ì´ˆ í›„ ìš”ì†Œ ì œê±°
            setTimeout(() => {
                if (floatingText.parentNode) {
                    floatingText.parentNode.removeChild(floatingText);
                }
            }, 1500);
        }

        function createItemParticles(x, y, itemType) {
            const canvas = document.getElementById('gameCanvas');
            const rect = canvas.getBoundingClientRect();
            const particleCount = 6;
            
            // ìº”ë²„ìŠ¤ ì¢Œí‘œë¥¼ í™”ë©´ ì¢Œí‘œë¡œ ë³€í™˜
            const screenX = rect.left + (x * rect.width / canvas.width);
            const screenY = rect.top + (y * rect.height / canvas.height);
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = `item-particle ${itemType}`;
                
                // ëœë¤í•œ ë°©í–¥ìœ¼ë¡œ íŒŒí‹°í´ ë°°ì¹˜
                const angle = (Math.PI * 2 * i) / particleCount;
                const distance = 15 + Math.random() * 10;
                const particleX = screenX + Math.cos(angle) * distance;
                const particleY = screenY + Math.sin(angle) * distance;
                
                particle.style.left = particleX + 'px';
                particle.style.top = particleY + 'px';
                
                document.body.appendChild(particle);
                
                // 0.8ì´ˆ í›„ íŒŒí‹°í´ ì œê±°
                setTimeout(() => {
                    if (particle.parentNode) {
                        particle.parentNode.removeChild(particle);
                    }
                }, 800);
            }
        }

        function showShieldActivationEffect() {
            const canvas = document.getElementById('gameCanvas');
            const rect = canvas.getBoundingClientRect();
            
            // ìºë¦­í„° ìœ„ì¹˜ ê³„ì‚° (ìº”ë²„ìŠ¤ ê¸°ì¤€ â†’ í™”ë©´ ê¸°ì¤€)
            const characterScreenX = rect.left + ((character.x + character.width/2) * rect.width / canvas.width);
            const characterScreenY = rect.top + ((character.y + character.height/2) * rect.height / canvas.height);
            
            const shieldEffect = document.createElement('div');
            shieldEffect.className = 'shield-effect';
            shieldEffect.style.left = (characterScreenX - 30) + 'px';
            shieldEffect.style.top = (characterScreenY - 30) + 'px';
            shieldEffect.style.width = '60px';
            shieldEffect.style.height = '60px';
            
            document.body.appendChild(shieldEffect);
            
            // 0.3ì´ˆ í›„ íš¨ê³¼ ì œê±°
            setTimeout(() => {
                if (shieldEffect.parentNode) {
                    shieldEffect.parentNode.removeChild(shieldEffect);
                }
            }, 300);
        }

        // ë°©ë¬¸ì ìˆ˜ ê´€ë¦¬
        async function updateVisitorCount() {
            if (!window.firebaseDB) return;
            
            try {
                const today = new Date().toDateString();
                const { doc, setDoc, getDoc, updateDoc, increment } = window.firestoreModules;
                
                // ì´ ë°©ë¬¸ì ìˆ˜ ì—…ë°ì´íŠ¸
                const totalVisitorRef = doc(window.firebaseDB, 'visitor_stats', 'total');
                try {
                    await updateDoc(totalVisitorRef, {
                        count: increment(1),
                        lastUpdate: Date.now()
                    });
                } catch (error) {
                    await setDoc(totalVisitorRef, {
                        count: 1,
                        lastUpdate: Date.now()
                    });
                }
                
                // ì˜¤ëŠ˜ ë°©ë¬¸ì ìˆ˜ ì—…ë°ì´íŠ¸
                const todayVisitorRef = doc(window.firebaseDB, 'visitor_stats', `daily_${today.replace(/\s/g, '_')}`);
                try {
                    await updateDoc(todayVisitorRef, {
                        count: increment(1),
                        date: today,
                        lastUpdate: Date.now()
                    });
                } catch (error) {
                    await setDoc(todayVisitorRef, {
                        count: 1,
                        date: today,
                        lastUpdate: Date.now()
                    });
                }
                
                loadVisitorCount();
                
            } catch (error) {
                console.error('ë°©ë¬¸ì ìˆ˜ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                document.getElementById('visitorCount').textContent = 'ë°©ë¬¸ì: ì§‘ê³„ ì˜¤ë¥˜';
            }
        }
        
        async function loadVisitorCount() {
            if (!window.firebaseDB) {
                document.getElementById('visitorCount').textContent = 'ë°©ë¬¸ì: ì§‘ê³„ ë¶ˆê°€';
                return;
            }
            
            try {
                const today = new Date().toDateString();
                const { doc, getDoc } = window.firestoreModules;
                
                const totalVisitorRef = doc(window.firebaseDB, 'visitor_stats', 'total');
                const totalDoc = await getDoc(totalVisitorRef);
                const totalCount = totalDoc.exists() ? (totalDoc.data().count || 0) : 0;
                
                const todayVisitorRef = doc(window.firebaseDB, 'visitor_stats', `daily_${today.replace(/\s/g, '_')}`);
                const todayDoc = await getDoc(todayVisitorRef);
                const todayCount = todayDoc.exists() ? (todayDoc.data().count || 0) : 0;
                
                document.getElementById('visitorCount').textContent = `ì´ ë°©ë¬¸ì: ${totalCount} | ì˜¤ëŠ˜: ${todayCount}`;
                
            } catch (error) {
                console.error('ë°©ë¬¸ì ìˆ˜ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('visitorCount').textContent = 'ë°©ë¬¸ì: ì§‘ê³„ ì˜¤ë¥˜';
            }
        }

// ê°œì„ ëœ ê³µì§€ì‚¬í•­ ê´€ë¦¬ (ì—ëŸ¬ í•´ê²°)
        async function loadNotices() {
            if (!window.firebaseDB) return;
            
            try {
                const { collection, getDocs, query, where } = window.firestoreModules;
                
                // ë‹¨ìˆœ ì¿¼ë¦¬ë¡œ ë³€ê²½í•˜ì—¬ ì¸ë±ìŠ¤ ì˜¤ë¥˜ ë°©ì§€
                const q = query(
                    collection(window.firebaseDB, 'notices'),
                    where('isActive', '==', true)
                );
                
                const snapshot = await getDocs(q);
                const notices = [];
                const now = Date.now();
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    // ë§Œë£Œì¼ í™•ì¸
                    if (data.expireDate && new Date(data.expireDate).getTime() < now) {
                        return;
                    }
                    
                    notices.push({ id: doc.id, ...data });
                });
                
                // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬
                notices.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
                
                if (notices.length > 0) {
                    console.log('ê³µì§€ì‚¬í•­ ë¡œë“œë¨:', notices.length + 'ê°œ');
                    checkAndShowNotices(notices);
                }
                
            } catch (error) {
                console.error('ê³µì§€ì‚¬í•­ ë¡œë“œ ì˜¤ë¥˜:', error);
                loadNoticesAlternative();
            }
        }
        
        // ëŒ€ì•ˆ ê³µì§€ì‚¬í•­ ë¡œë“œ ë°©ë²•
        async function loadNoticesAlternative() {
            try {
                const { collection, getDocs } = window.firestoreModules;
                const snapshot = await getDocs(collection(window.firebaseDB, 'notices'));
                
                const notices = [];
                const now = Date.now();
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    if (data.isActive && (!data.expireDate || new Date(data.expireDate).getTime() >= now)) {
                        notices.push({ id: doc.id, ...data });
                    }
                });
                
                notices.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
                
                if (notices.length > 0) {
                    console.log('ê³µì§€ì‚¬í•­ ëŒ€ì•ˆ ë¡œë“œë¨:', notices.length + 'ê°œ');
                    checkAndShowNotices(notices);
                }
                
            } catch (error) {
                console.error('ê³µì§€ì‚¬í•­ ëŒ€ì•ˆ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        
        function checkAndShowNotices(notices) {
            if (notices.length === 0) return;
            
            const today = new Date().toDateString();
            const hiddenNotices = JSON.parse(localStorage.getItem(`hiddenNotices_${today}`) || '[]');
            
            const visibleNotices = notices.filter(notice => !hiddenNotices.includes(notice.id));
            
            if (visibleNotices.length > 0) {
                pendingNotices = visibleNotices;
                currentNoticeIndex = 0;
                setTimeout(showNextNotice, 2000);
            }
        }
        
        function showNextNotice() {
            if (currentNoticeIndex >= pendingNotices.length) return;
            
            const notice = pendingNotices[currentNoticeIndex];
            document.getElementById('noticeModalTitle').textContent = notice.title;
            document.getElementById('noticeModalContent').textContent = notice.content;
            document.getElementById('dontShowToday').checked = false;
            document.getElementById('noticeModal').classList.remove('hidden');
        }
        
        function closeNoticeModal() {
            const dontShow = document.getElementById('dontShowToday').checked;
            
            if (dontShow) {
                const today = new Date().toDateString();
                const hiddenNotices = JSON.parse(localStorage.getItem(`hiddenNotices_${today}`) || '[]');
                const currentNotice = pendingNotices[currentNoticeIndex];
                
                if (!hiddenNotices.includes(currentNotice.id)) {
                    hiddenNotices.push(currentNotice.id);
                    localStorage.setItem(`hiddenNotices_${today}`, JSON.stringify(hiddenNotices));
                }
            }
            
            document.getElementById('noticeModal').classList.add('hidden');
            currentNoticeIndex++;
            
            if (currentNoticeIndex < pendingNotices.length) {
                setTimeout(showNextNotice, 1000);
            }
        }

        // ê´€ë¦¬ì ê³µì§€ì‚¬í•­ ê´€ë¦¬
        function switchAdminTab(tabName) {
            document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.admin-tab:nth-child(${tabName === 'ranking' ? 1 : 2})`).classList.add('active');
            
            document.querySelectorAll('.admin-tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            if (tabName === 'notice') {
                loadAdminNotices();
            }
        }
        
        async function saveNotice() {
            const title = document.getElementById('noticeTitle').value.trim();
            const content = document.getElementById('noticeContent').value.trim();
            const expireDate = document.getElementById('noticeExpireDate').value;
            const messageEl = document.getElementById('noticeMessage');
            
            if (!title || !content) {
                messageEl.innerHTML = '<div class="error-message">ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”</div>';
                return;
            }
            
            if (!window.firebaseDB) {
                messageEl.innerHTML = '<div class="error-message">Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤</div>';
                return;
            }
            
            try {
                messageEl.innerHTML = '<div class="loading">ê³µì§€ì‚¬í•­ ì €ì¥ ì¤‘...</div>';
                
                const { collection, addDoc } = window.firestoreModules;
                const noticeData = {
                    title: title,
                    content: content,
                    isActive: true,
                    createdAt: Date.now(),
                    createdBy: 'admin'
                };
                
                if (expireDate) {
                    noticeData.expireDate = expireDate;
                }
                
                await addDoc(collection(window.firebaseDB, 'notices'), noticeData);
                
                messageEl.innerHTML = '<div class="success-message">ê³µì§€ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤</div>';
                clearNoticeForm();
                loadAdminNotices();
                
            } catch (error) {
                console.error('ê³µì§€ì‚¬í•­ ì €ì¥ ì˜¤ë¥˜:', error);
                messageEl.innerHTML = '<div class="error-message">ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message + '</div>';
            }
        }
        
        function clearNoticeForm() {
            document.getElementById('noticeTitle').value = '';
            document.getElementById('noticeContent').value = '';
            document.getElementById('noticeExpireDate').value = '';
            document.getElementById('noticeMessage').innerHTML = '';
        }
        
        async function loadAdminNotices() {
            if (!window.firebaseDB) return;
            
            try {
                const { collection, getDocs } = window.firestoreModules;
                const snapshot = await getDocs(collection(window.firebaseDB, 'notices'));
                
                let html = '';
                const now = Date.now();
                const notices = [];
                
                snapshot.forEach((doc) => {
                    notices.push({ id: doc.id, ...doc.data() });
                });
                
                notices.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                
                if (notices.length === 0) {
                    html = '<p>ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    notices.forEach((data) => {
                        const isExpired = data.expireDate && new Date(data.expireDate).getTime() < now;
                        const statusText = data.isActive ? (isExpired ? 'ë§Œë£Œë¨' : 'í™œì„±') : 'ë¹„í™œì„±';
                        const statusColor = data.isActive ? (isExpired ? '#ff9800' : '#4CAF50') : '#f44336';
                        
                        html += `
                            <div class="notice-item ${isExpired ? 'expired' : ''}">
                                <div class="notice-item-title">${data.title}</div>
                                <div class="notice-item-meta">
                                    ì‘ì„±ì¼: ${new Date(data.createdAt).toLocaleDateString('ko-KR')} | 
                                    ìƒíƒœ: <span style="color: ${statusColor}">${statusText}</span>
                                    ${data.expireDate ? ` | ë§Œë£Œì¼: ${new Date(data.expireDate).toLocaleDateString('ko-KR')}` : ''}
                                </div>
                                <div style="margin-top: 10px; color: #666; font-size: 14px;">${data.content}</div>
                                <div class="notice-item-actions">
                                    ${data.isActive ? 
                                        `<button class="danger" style="padding: 5px 10px; font-size: 12px;" onclick="deactivateNotice('${data.id}')">ë¹„í™œì„±í™”</button>` :
                                        `<button class="secondary" style="padding: 5px 10px; font-size: 12px;" onclick="activateNotice('${data.id}')">í™œì„±í™”</button>`
                                    }
                                    <button class="danger" style="padding: 5px 10px; font-size: 12px; margin-left: 5px;" onclick="deleteNotice('${data.id}')">ì‚­ì œ</button>
                                </div>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('noticeList').innerHTML = html;
                
            } catch (error) {
                console.error('ê´€ë¦¬ì ê³µì§€ì‚¬í•­ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('noticeList').innerHTML = '<p>ê³µì§€ì‚¬í•­ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message + '</p>';
            }
        }
        
        async function deactivateNotice(noticeId) {
            try {
                const { doc, updateDoc } = window.firestoreModules;
                await updateDoc(doc(window.firebaseDB, 'notices', noticeId), { isActive: false });
                loadAdminNotices();
            } catch (error) {
                console.error('ê³µì§€ì‚¬í•­ ë¹„í™œì„±í™” ì˜¤ë¥˜:', error);
            }
        }
        
        async function activateNotice(noticeId) {
            try {
                const { doc, updateDoc } = window.firestoreModules;
                await updateDoc(doc(window.firebaseDB, 'notices', noticeId), { isActive: true });
                loadAdminNotices();
            } catch (error) {
                console.error('ê³µì§€ì‚¬í•­ í™œì„±í™” ì˜¤ë¥˜:', error);
            }
        }
        
        async function deleteNotice(noticeId) {
            if (!confirm('ì •ë§ë¡œ ì´ ê³µì§€ì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            try {
                const { doc, deleteDoc } = window.firestoreModules;
                await deleteDoc(doc(window.firebaseDB, 'notices', noticeId));
                loadAdminNotices();
            } catch (error) {
                console.error('ê³µì§€ì‚¬í•­ ì‚­ì œ ì˜¤ë¥˜:', error);
            }
        }

        // ê°œì„ ëœ ë­í‚¹ ì´ˆê¸°í™” (ìƒìœ„ 10ìœ„ë§Œ ë°±ì—…)
        async function resetRankings() {
            if (!window.firebaseDB) {
                document.getElementById('adminMessage').innerHTML = '<div class="error-message">Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤</div>';
                return;
            }
            
            if (!confirm('ì •ë§ë¡œ ë­í‚¹ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nìƒìœ„ 10ìœ„ ê¸°ë¡ì´ ë°±ì—…ë©ë‹ˆë‹¤.')) {
                return;
            }
            
            try {
                document.getElementById('adminMessage').innerHTML = '<div class="loading">ë­í‚¹ ì´ˆê¸°í™” ì¤‘...</div>';
                
                const { collection, query, orderBy, limit, getDocs, setDoc, deleteDoc, doc } = window.firestoreModules;
                
                const top10Query = query(
                    collection(window.firebaseDB, 'rankings'), 
                    orderBy('score', 'desc'), 
                    limit(10)
                );
                const snapshot = await getDocs(top10Query);
                
                const resetDate = new Date().toLocaleString('ko-KR');
                const resetNumber = Date.now();
                
                const backupRankings = [];
                let rankCounter = 1;
                snapshot.forEach((docSnapshot) => {
                    const data = docSnapshot.data();
                    backupRankings.push({
                        rank: rankCounter++,
                        nickname: data.nickname,
                        score: data.score,
                        date: data.date,
                        device: data.device,
                        timestamp: data.timestamp
                    });
                });
                
                const backupDoc = {
                    resetDate: resetDate,
                    resetNumber: resetNumber,
                    rankings: backupRankings,
                    totalBackedUp: backupRankings.length
                };
                
                await setDoc(doc(window.firebaseDB, 'backup_rankings', `reset_${resetNumber}`), backupDoc);
                
                const allRankingsQuery = query(collection(window.firebaseDB, 'rankings'));
                const allSnapshot = await getDocs(allRankingsQuery);
                const deletePromises = [];
                allSnapshot.forEach((docSnapshot) => {
                    deletePromises.push(deleteDoc(doc(window.firebaseDB, 'rankings', docSnapshot.id)));
                });
                await Promise.all(deletePromises);
                
                document.getElementById('adminMessage').innerHTML = `<div class="success-message">ë­í‚¹ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!<br>ìƒìœ„ ${backupRankings.length}ìœ„ ë°±ì—… ì™„ë£Œ<br>ì´ˆê¸°í™” ë‚ ì§œ: ${resetDate}</div>`;
                loadTop3Rankings();
                
            } catch (error) {
                console.error('ë­í‚¹ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                document.getElementById('adminMessage').innerHTML = '<div class="error-message">ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message + '</div>';
            }
        }
        
        async function viewBackupData() {
            if (!window.firebaseDB) {
                document.getElementById('adminMessage').innerHTML = '<div class="error-message">Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤</div>';
                return;
            }
            
            try {
                const { collection, query, orderBy, getDocs } = window.firestoreModules;
                const backupQuery = query(collection(window.firebaseDB, 'backup_rankings'), orderBy('resetNumber', 'desc'));
                const snapshot = await getDocs(backupQuery);
                
                let html = '<h3>ë°±ì—…ëœ ë­í‚¹ ê¸°ë¡</h3>';
                
                if (snapshot.empty) {
                    html += '<p>ë°±ì—…ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    const totalResets = snapshot.size;
                    let resetIndex = 0;
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const resetDate = data.resetDate || 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
                        resetIndex++;
                        const displayIndex = totalResets - resetIndex + 1;
                        
                        html += `<h4 style="margin-top: 20px; color: #2196F3;">${displayIndex}ë²ˆì§¸ ì´ˆê¸°í™” (${resetDate})</h4>`;
                        html += `<p style="font-size: 12px; color: #666;">ì´ ${data.totalBackedUp || 0}ëª… ë°±ì—…</p>`;
                        
                        if (data.rankings && data.rankings.length > 0) {
                            data.rankings.forEach((ranking) => {
                                const deviceIcon = ranking.device === 'mobile' ? 'ğŸ“±' : 'ğŸ’»';
                                html += `<div class="backup-item">
                                    ${ranking.rank}ìœ„. ${ranking.nickname} ${deviceIcon} - ${ranking.score}ì  
                                    <br><small>ê¸°ë¡ì¼: ${ranking.date || 'ì •ë³´ ì—†ìŒ'}</small>
                                </div>`;
                            });
                        }
                    });
                }
                
                document.getElementById('backupDisplay').innerHTML = html;
                
            } catch (error) {
                console.error('ë°±ì—… ì¡°íšŒ ì˜¤ë¥˜:', error);
                document.getElementById('adminMessage').innerHTML = '<div class="error-message">ë°±ì—… ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message + '</div>';
            }
        }
        
        function closeAdminModal() {
            document.getElementById('adminModal').classList.add('hidden');
            document.getElementById('adminMessage').innerHTML = '';
            document.getElementById('backupDisplay').innerHTML = '';
        }

// ì´ë¯¸ì§€ ê´€ë¦¬ ì‹œìŠ¤í…œ
        const gameImages = {
            background: null,
            character: null,
            ground: null,
            bomb: null,
            bomb1: null,  // bomb1.png ì¶”ê°€
            item1: null,
            item2: null,
            shield: null,
            loaded: {
                background: false,
                character: false,
                ground: false,
                bomb: false,
                bomb1: false,  // bomb1.png ë¡œë“œ ìƒíƒœ ì¶”ê°€
                item1: false,
                item2: false,
                shield: false
            }
        };
        
        const GROUND_HEIGHT = isMobile ? 60 : 80;
        
        function loadGameImage(key, filename) {
            const img = new Image();
            img.onload = function() {
                gameImages[key] = img;
                gameImages.loaded[key] = true;
                console.log(`${filename} ë¡œë”© ì„±ê³µ`);
            };
            img.onerror = function() {
                console.log(`${filename} ë¡œë”© ì‹¤íŒ¨ - ê¸°ë³¸ ê·¸ë˜í”½ ì‚¬ìš©`);
                gameImages.loaded[key] = false;
            };
            img.src = filename;
        }
        
        // ëª¨ë“  ì´ë¯¸ì§€ ë¡œë”© (bomb1.png ì¶”ê°€)
        loadGameImage('background', 'background.png');
        loadGameImage('character', 'martin.png');
        loadGameImage('ground', 'ground.png');
        loadGameImage('bomb', 'bomb.png');
        loadGameImage('bomb1', 'bomb1.png');  // ìƒˆë¡œìš´ í­íƒ„ ì´ë¯¸ì§€ ì¶”ê°€
        loadGameImage('item1', 'item1.png');
        loadGameImage('item2', 'item2.png');
        loadGameImage('shield', 'shield.png');

        // ìºë¦­í„° ì„¤ì • (í„°ì¹˜ ë°©í–¥ ì „í™˜ ë°©ì‹)
        const character = {
            x: 0,
            y: 0,
            width: currentConfig.characterSize,
            height: currentConfig.characterSize,
            direction: 1,  // 1: ì˜¤ë¥¸ìª½, -1: ì™¼ìª½
            movingDirection: 1,  // í˜„ì¬ ì´ë™ ë°©í–¥
            speed: currentConfig.moveSpeed,
            facingRight: true  // ìºë¦­í„°ê°€ ì˜¤ë¥¸ìª½ì„ ë³´ê³  ìˆëŠ”ì§€ ì—¬ë¶€
        };

        // ì„±ëŠ¥ ìµœì í™”
        const targetFPS = isMobile ? 45 : 60;
        let lastTime = 0;
        let deltaTime = 0;
        const frameDelay = 1000 / targetFPS;

        // ê²Œì„ ê·¸ë¦¬ê¸° í•¨ìˆ˜ë“¤
        function drawCharacter() {
            ctx.save();
            
            // ë¬´ì  ì‹¤ë“œ íš¨ê³¼
            if (isInvulnerable) {
                ctx.strokeStyle = 'rgba(255, 140, 0, 0.8)';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.arc(character.x + character.width/2, character.y + character.height/2, character.width/2 + 8, 0, Math.PI * 2);
                ctx.stroke();
            }
            
            // ìºë¦­í„° ì¢Œìš° ë°˜ì „ ì²˜ë¦¬
            if (!character.facingRight) {
                ctx.scale(-1, 1);
                ctx.translate(-character.x - character.width, character.y);
            } else {
                ctx.translate(character.x, character.y);
            }
            
            if (gameImages.loaded.character && gameImages.character) {
                ctx.drawImage(
                    gameImages.character,
                    0, 0,
                    character.width, character.height
                );
            } else {
                // ê¸°ë³¸ ìºë¦­í„° ê·¸ë¦¬ê¸°
                ctx.fillStyle = '#FF6B35';
                ctx.beginPath();
                ctx.arc(character.width/2, character.height/2, character.width/2, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(character.width/2 - 8, character.height/2 - 8, 6, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.arc(character.width/2 - 8, character.height/2 - 8, 3, 0, Math.PI * 2);
                ctx.fill();
            }
            
            ctx.restore();
        }

        function drawEnvironment() {
            // ë°°ê²½ ê·¸ë¦¬ê¸°
            if (gameImages.loaded.background && gameImages.background) {
                ctx.drawImage(gameImages.background, 0, 0, canvas.width, canvas.height);
            } else {
                // ê¸°ë³¸ ë°°ê²½ ê·¸ë¦¬ê¸°
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height - GROUND_HEIGHT);
                gradient.addColorStop(0, '#87CEEB');
                gradient.addColorStop(1, '#98FB98');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height - GROUND_HEIGHT);
            }
            
            // ë°”ë‹¥ ê·¸ë¦¬ê¸°
            const groundY = canvas.height - GROUND_HEIGHT;
            
            if (gameImages.loaded.ground && gameImages.ground) {
                ctx.drawImage(gameImages.ground, 0, groundY, canvas.width, GROUND_HEIGHT);
            } else {
                // ê¸°ë³¸ ë°”ë‹¥ ê·¸ë¦¬ê¸°
                ctx.fillStyle = '#90EE90';
                ctx.fillRect(0, groundY, canvas.width, GROUND_HEIGHT);
                
                ctx.strokeStyle = '#228B22';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(0, groundY);
                ctx.lineTo(canvas.width, groundY);
                ctx.stroke();
            }
        }

        // í„°ì¹˜ ë°©í–¥ ì „í™˜ ë°©ì‹ì˜ ìºë¦­í„° ì—…ë°ì´íŠ¸
        function updateCharacter() {
            // í˜„ì¬ ë°©í–¥ìœ¼ë¡œ ì§€ì†ì ìœ¼ë¡œ ì´ë™
            character.x += character.movingDirection * character.speed;
            
            // í™”ë©´ ê²½ê³„ì—ì„œ ë°©í–¥ ìë™ ì „í™˜
            if (character.x <= 0) {
                character.x = 0;
                character.movingDirection = 1;
                character.facingRight = true;
            } else if (character.x >= canvas.width - character.width) {
                character.x = canvas.width - character.width;
                character.movingDirection = -1;
                character.facingRight = false;
            }
        }

        // í„°ì¹˜/í´ë¦­ìœ¼ë¡œ ë°©í–¥ ì „í™˜
        function changeDirection() {
            if (gameState !== 'playing') return;
            
            character.movingDirection *= -1;
            character.facingRight = character.movingDirection > 0;
            
            console.log(`ë°©í–¥ ì „í™˜: ${character.facingRight ? 'ì˜¤ë¥¸ìª½' : 'ì™¼ìª½'}`);
        }

        function updateScore() {
            document.getElementById('score').textContent = `ì ìˆ˜: ${score}`;
        }

        // ë°©ë¬¸ì ì¹´ìš´í„° í‘œì‹œ/ìˆ¨ê¸°ê¸° í•¨ìˆ˜
        function updateVisitorCounterVisibility() {
            const visitorCounter = document.getElementById('visitorCounter');
            if (gameState === 'playing') {
                visitorCounter.classList.add('game-playing');
            } else {
                visitorCounter.classList.remove('game-playing');
            }
        }

        // ê²Œì„ ì‹œì‘ í•¨ìˆ˜
        function startGame() {
            console.log(`Martin Bomb Dodger ì‹œì‘! (${isMobile ? 'ëª¨ë°”ì¼' : 'ë°ìŠ¤í¬íƒ‘'} ëª¨ë“œ)`);
            gameState = 'playing';
            score = 0;
            difficultyLevel = 1;
            
            // ë¬´ì  ì‹¤ë“œ ì´ˆê¸°í™”
            deactivateInvulnerability();
            
            // ì•„ì´í…œ ì´ˆê¸°í™”
            bombs = [];
            bonusItems = [];
            bombTimer = 0;
            bonusTimer = 0;
            
            // ì„¤ì • ì—…ë°ì´íŠ¸
            currentConfig = isMobile ? DEVICE_CONFIGS.mobile : DEVICE_CONFIGS.desktop;
            gameSpeed = currentConfig.gameSpeed;
            
            // ìºë¦­í„° ìœ„ì¹˜ ì„¤ì • (í™”ë©´ ì¤‘ì•™ í•˜ë‹¨, ì˜¤ë¥¸ìª½ ë°©í–¥ìœ¼ë¡œ ì‹œì‘)
            character.x = canvas.width / 2 - character.width / 2;
            character.y = canvas.height - GROUND_HEIGHT - character.height - 10;
            character.width = currentConfig.characterSize;
            character.height = currentConfig.characterSize;
            character.speed = currentConfig.moveSpeed;
            character.movingDirection = 1;  // ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì‹œì‘
            character.facingRight = true;
            
            updateScore();
            updateVisitorCounterVisibility();
            
            // UI ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('rankCheckModal').classList.add('hidden');
        }

        // ê²Œì„ì˜¤ë²„ í•¨ìˆ˜
        async function gameOver() {
            gameState = 'gameOver';
            deactivateInvulnerability();
            updateVisitorCounterVisibility();
            document.getElementById('finalScore').textContent = `ìµœì¢… ì ìˆ˜: ${score}`;
            
            const isTop10 = await checkTop10Eligibility(score);
            
            if (isTop10) {
                showRankCheckModal();
            } else {
                document.getElementById('nameInputSection').classList.add('hidden');
                document.getElementById('gameEndButtons').classList.remove('hidden');
                clearGameOverInputs();
                document.getElementById('gameOverScreen').classList.remove('hidden');
            }
        }

        // ê²Œì„ ì¬ì‹œì‘
        function restartGame() {
            startGame();
        }

        // ì‹œì‘ í™”ë©´ìœ¼ë¡œ
        function showStartScreen() {
            gameState = 'start';
            updateVisitorCounterVisibility();
            document.getElementById('startScreen').classList.remove('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('rankCheckModal').classList.add('hidden');
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('checkNickname').value = '';
            document.getElementById('checkPin').value = '';
            document.getElementById('myRankDisplay').innerHTML = '';
        }

        // ì…ë ¥ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function clearGameOverInputs() {
            document.getElementById('playerName').value = '';
            document.getElementById('playerPin').value = '';
            document.getElementById('submitMessage').innerHTML = '';
        }

        // í„°ì¹˜ ë° í´ë¦­ ì´ë²¤íŠ¸ (ë°©í–¥ ì „í™˜)
        canvas.addEventListener('click', changeDirection);
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            changeDirection();
        }, { passive: false });

        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ (ìŠ¤í˜ì´ìŠ¤ë°”ë¡œë„ ë°©í–¥ ì „í™˜ ê°€ëŠ¥)
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                changeDirection();
            }
        });

        // Enter í‚¤ ì´ë²¤íŠ¸ë“¤
        document.getElementById('checkNickname').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('checkPin').focus();
            }
        });

        document.getElementById('checkPin').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                checkMyRanking();
            }
        });

        document.getElementById('playerName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('playerPin').focus();
            }
        });

        document.getElementById('playerPin').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitScore();
            }
        });

        // ì…ë ¥ ì œí•œ í•¨ìˆ˜ë“¤
        function setupPinValidation(elementId) {
            const pinInput = document.getElementById(elementId);
            
            pinInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
                if (e.target.value.length > 6) {
                    e.target.value = e.target.value.slice(0, 6);
                }
            });
            
            pinInput.addEventListener('keydown', (e) => {
                if (!/[0-9]/.test(e.key) && 
                    !['Backspace', 'Delete', 'Tab', 'Enter', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                    e.preventDefault();
                }
            });
        }

        function setupNicknameValidation(elementId) {
            const nicknameInput = document.getElementById(elementId);
            
            nicknameInput.addEventListener('input', (e) => {
                let value = e.target.value;
                
                if (e.inputType === 'insertCompositionText' || e.isComposing) {
                    return;
                }
                
                value = value.replace(/[^ê°€-í£a-zA-Z0-9_]/g, '');
                
                if (value.length > 20) {
                    value = value.slice(0, 20);
                }
                
                e.target.value = value;
            });
            
            nicknameInput.addEventListener('compositionend', (e) => {
                let value = e.target.value;
                value = value.replace(/[^ê°€-í£a-zA-Z0-9_]/g, '');
                if (value.length > 20) {
                    value = value.slice(0, 20);
                }
                e.target.value = value;
            });
        }

        // ì…ë ¥ ì œí•œ ì´ˆê¸°í™”
        setupPinValidation('checkPin');
        setupPinValidation('playerPin');
        setupNicknameValidation('checkNickname');
        setupNicknameValidation('playerName');

        // í™”ë©´ í¬ê¸° ë³€ê²½ ê°ì§€
        window.addEventListener('resize', () => {
            setupCanvas();
            currentConfig = isMobile ? DEVICE_CONFIGS.mobile : DEVICE_CONFIGS.desktop;
            if (gameState === 'playing') {
                character.speed = currentConfig.moveSpeed;
            }
        });

        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                setVH();
                setupCanvas();
            }, 100);
        });

// í­íƒ„ ìƒì„± í•¨ìˆ˜ (bomb.pngì™€ bomb1.png ë‘ ë°°ë¡œ ìƒì„±)
        function createBomb() {
            if (bombs.length >= 16) return; // í­íƒ„ì´ ë‘ ë°°ê°€ ë˜ë¯€ë¡œ ìµœëŒ€ ê°œìˆ˜ë„ ì¦ê°€
            
            const bombSize = currentConfig.itemSize;
            const spawnWidth = canvas.width * currentConfig.spawnWidth;
            const spawnMargin = (canvas.width - spawnWidth) / 2;
            
            // ì²« ë²ˆì§¸ í­íƒ„ (ê¸°ì¡´ bomb.png)
            const bomb1X = spawnMargin + Math.random() * spawnWidth;
            const speed1Variation = 1 + (Math.random() - 0.5) * currentConfig.itemSpeedVariation;
            
            bombs.push({
                x: bomb1X,
                y: -bombSize,
                width: bombSize,
                height: bombSize,
                speed: gameSpeed * speed1Variation,
                passed: false,
                type: 'bomb'  // í­íƒ„ íƒ€ì… ì¶”ê°€
            });
            
            // ë‘ ë²ˆì§¸ í­íƒ„ (ìƒˆë¡œìš´ bomb1.png)
            const bomb2X = spawnMargin + Math.random() * spawnWidth;
            const speed2Variation = 1 + (Math.random() - 0.5) * currentConfig.itemSpeedVariation;
            
            bombs.push({
                x: bomb2X,
                y: -bombSize - Math.random() * 100, // ì•½ê°„ ë‹¤ë¥¸ Y ìœ„ì¹˜ì—ì„œ ì‹œì‘
                width: bombSize,
                height: bombSize,
                speed: gameSpeed * speed2Variation,
                passed: false,
                type: 'bomb1'  // ìƒˆë¡œìš´ í­íƒ„ íƒ€ì…
            });
            
            console.log(`í­íƒ„ ìƒì„±: bomb(${Math.round(bomb1X)}), bomb1(${Math.round(bomb2X)})`);
        }

        // ë³´ë„ˆìŠ¤ ì•„ì´í…œ ìƒì„± í•¨ìˆ˜
        function createBonusItem() {
            if (bonusItems.length >= 4) return; // í™”ë©´ì— ë„ˆë¬´ ë§ì€ ì•„ì´í…œ ë°©ì§€
            
            const itemType = selectRandomBonusItem();
            const itemSize = currentConfig.itemSize;
            const spawnWidth = canvas.width * currentConfig.spawnWidth;
            const spawnMargin = (canvas.width - spawnWidth) / 2;
            
            const itemX = spawnMargin + Math.random() * spawnWidth;
            const speedVariation = 1 + (Math.random() - 0.5) * currentConfig.itemSpeedVariation;
            
            bonusItems.push({
                x: itemX,
                y: -itemSize,
                width: itemSize,
                height: itemSize,
                speed: gameSpeed * speedVariation,
                type: itemType,
                collected: false
            });
            
            console.log(`ë³´ë„ˆìŠ¤ ì•„ì´í…œ ìƒì„±: ${itemType} at X=${Math.round(itemX)}`);
        }

        function updateBombs() {
            bombs.forEach(bomb => {
                bomb.y += bomb.speed;
                
                // í­íƒ„ì´ í™”ë©´ì„ ë²—ì–´ë‚¬ì„ ë•Œ ì ìˆ˜ ì¦ê°€ (ì„±ê³µì ìœ¼ë¡œ í”¼í•¨)
                if (!bomb.passed && bomb.y > canvas.height) {
                    bomb.passed = true;
                    score += 1; // í­íƒ„ í•˜ë‚˜ë‹¹ 1ì 
                    updateScore();
                    
                    // 20ì ë§ˆë‹¤ ë‚œì´ë„ ì¦ê°€
                    if (score > 0 && score % 20 === 0) {
                        difficultyLevel++;
                        gameSpeed += currentConfig.speedIncrease;
                        currentConfig.bombInterval = Math.max(20, currentConfig.bombInterval - currentConfig.intervalDecrease);
                        console.log(`ë‚œì´ë„ ì¦ê°€! ë ˆë²¨: ${difficultyLevel}, ë‚™í•˜ì†ë„: ${gameSpeed.toFixed(1)}`);
                    }
                }
            });
            
            // í™”ë©´ì„ ë²—ì–´ë‚œ í­íƒ„ ì œê±°
            bombs = bombs.filter(bomb => bomb.y < canvas.height + bomb.height);
            
            // í­íƒ„ ìƒì„± íƒ€ì´ë¨¸
            bombTimer++;
            if (bombTimer >= currentConfig.bombInterval) {
                if (Math.random() < currentConfig.bombProbability) {
                    createBomb();
                }
                bombTimer = 0;
            }
        }

        function updateBonusItems() {
            bonusItems.forEach(item => {
                item.y += item.speed;
            });
            
            // í™”ë©´ì„ ë²—ì–´ë‚œ ì•„ì´í…œ ì œê±°
            bonusItems = bonusItems.filter(item => item.y < canvas.height + item.height && !item.collected);
            
            // ë³´ë„ˆìŠ¤ ì•„ì´í…œ ìƒì„± íƒ€ì´ë¨¸
            bonusTimer++;
            if (bonusTimer >= currentConfig.bonusInterval) {
                if (Math.random() < currentConfig.bonusItemProbability) {
                    createBonusItem();
                }
                bonusTimer = 0;
            }
        }

        function drawBombs() {
            bombs.forEach(bomb => {
                // bomb íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥¸ ì´ë¯¸ì§€ ì‚¬ìš©
                const bombImageKey = bomb.type; // 'bomb' ë˜ëŠ” 'bomb1'
                
                if (gameImages.loaded[bombImageKey] && gameImages[bombImageKey]) {
                    ctx.drawImage(
                        gameImages[bombImageKey],
                        bomb.x, bomb.y,
                        bomb.width, bomb.height
                    );
                } else {
                    // ê¸°ë³¸ í­íƒ„ ê·¸ë¦¬ê¸° (íƒ€ì…ë³„ë¡œ ë‹¤ë¥¸ ìƒ‰ìƒ)
                    ctx.save();
                    if (bomb.type === 'bomb1') {
                        ctx.fillStyle = '#FF6666'; // bomb1ì€ ì¡°ê¸ˆ ë‹¤ë¥¸ ìƒ‰ìƒ
                        ctx.strokeStyle = '#CC0000';
                    } else {
                        ctx.fillStyle = '#FF4444'; // ê¸°ë³¸ bomb ìƒ‰ìƒ
                        ctx.strokeStyle = '#AA0000';
                    }
                    
                    ctx.beginPath();
                    ctx.roundRect(bomb.x, bomb.y, bomb.width, bomb.height, 8);
                    ctx.fill();
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('ğŸ’£', bomb.x + bomb.width/2, bomb.y + bomb.height/2 + 6);
                    ctx.restore();
                }
            });
        }

        function drawBonusItems() {
            bonusItems.forEach(item => {
                if (item.collected) return;
                
                // ì•„ì´í…œ ì´ë¯¸ì§€ê°€ ë¡œë“œëœ ê²½ìš°
                if (gameImages.loaded[item.type] && gameImages[item.type]) {
                    ctx.drawImage(
                        gameImages[item.type],
                        item.x, item.y,
                        item.width, item.height
                    );
                } else {
                    // ê¸°ë³¸ ì•„ì´í…œ ê·¸ë¦¬ê¸°
                    ctx.save();
                    
                    if (item.type === 'item1') {
                        ctx.fillStyle = '#FF8800';
                        ctx.strokeStyle = '#CC6600';
                    } else if (item.type === 'item2') {
                        ctx.fillStyle = '#4488FF';
                        ctx.strokeStyle = '#2266CC';
                    } else if (item.type === 'shield') {
                        ctx.fillStyle = 'rgba(255, 140, 0, 0.8)';
                        ctx.strokeStyle = 'rgba(255, 100, 0, 1)';
                        ctx.lineWidth = 4;
                        
                        ctx.beginPath();
                        ctx.arc(item.x + item.width/2, item.y + item.height/2, item.width/2 - 2, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.stroke();
                        
                        ctx.fillStyle = 'white';
                        ctx.font = 'bold 18px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('ğŸ›¡ï¸', item.x + item.width/2, item.y + item.height/2 + 6);
                        ctx.restore();
                        return;
                    }
                    
                    ctx.beginPath();
                    ctx.roundRect(item.x, item.y, item.width, item.height, 8);
                    ctx.fill();
                    ctx.lineWidth = 3;
                    ctx.stroke();
                    
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    const symbol = item.type === 'item1' ? '+10' : '?';
                    ctx.fillText(symbol, item.x + item.width/2, item.y + item.height/2 + 6);
                    ctx.restore();
                }
            });
        }

        function checkBombCollisions() {
            if (isInvulnerable) return; // ë¬´ì  ìƒíƒœì—ì„œëŠ” ì¶©ëŒ ë¬´ì‹œ
            
            const charLeft = character.x + 3;
            const charRight = character.x + character.width - 3;
            const charTop = character.y + 3;
            const charBottom = character.y + character.height - 3;
            
            bombs.forEach(bomb => {
                if (bomb.passed) return;
                
                if (charRight > bomb.x + 5 && charLeft < bomb.x + bomb.width - 5 &&
                    charBottom > bomb.y + 5 && charTop < bomb.y + bomb.height - 5) {
                    gameOver(); // í­íƒ„ì— ë§ìœ¼ë©´ ì¦‰ì‹œ ê²Œì„ì˜¤ë²„
                }
            });
        }

        function checkBonusItemCollisions() {
            const charLeft = character.x + 8;
            const charRight = character.x + character.width - 8;
            const charTop = character.y + 8;
            const charBottom = character.y + character.height - 8;
            
            bonusItems.forEach(item => {
                if (item.collected) return;
                
                if (charRight > item.x + 5 && charLeft < item.x + item.width - 5 &&
                    charBottom > item.y + 5 && charTop < item.y + item.height - 5) {
                    
                    item.collected = true;
                    handleBonusItemCollection(item.type, item.x + item.width/2, item.y + item.height/2);
                    console.log(`ë³´ë„ˆìŠ¤ ì•„ì´í…œ ìˆ˜ì§‘: ${item.type}`);
                }
            });
            
            // ìˆ˜ì§‘ëœ ì•„ì´í…œ ì œê±°
            bonusItems = bonusItems.filter(item => !item.collected);
        }

        function handleBonusItemCollection(itemType, itemX, itemY) {
            let scoreChange = 0;
            
            // íŒŒí‹°í´ íš¨ê³¼ ìƒì„±
            createItemParticles(itemX, itemY, itemType);
            
            switch (itemType) {
                case 'item1':
                    scoreChange = 10;
                    score += scoreChange;
                    showFloatingText(itemX, itemY, '+10', 'positive');
                    console.log('â­ ë³´ë„ˆìŠ¤ ì•„ì´í…œ: +10ì , í˜„ì¬ ì ìˆ˜:', score);
                    break;
                    
                case 'item2':
                    scoreChange = Math.floor(Math.random() * 41) - 20; // -20 ~ +20
                    if (scoreChange >= 0) {
                        score += scoreChange;
                        showFloatingText(itemX, itemY, `+${scoreChange}`, 'positive');
                    } else {
                        score = Math.max(0, score + scoreChange);
                        showFloatingText(itemX, itemY, `${scoreChange}`, 'negative');
                    }
                    console.log(`ğŸ² ë¯¸ìŠ¤í„°ë¦¬ ì•„ì´í…œ: ${scoreChange >= 0 ? '+' : ''}${scoreChange}ì , í˜„ì¬ ì ìˆ˜:`, score);
                    break;
                    
                case 'shield':
                    activateInvulnerability();
                    showFloatingText(itemX, itemY, 'ë¬´ì !', 'shield');
                    console.log('ğŸ›¡ï¸ ì‹¤ë“œ ì•„ì´í…œ: ë¬´ì  ì‹¤ë“œ íšë“!');
                    break;
            }
            
            updateScore();
        }

        // ê²Œì„ ë£¨í”„
        function gameLoop(currentTime) {
            deltaTime = currentTime - lastTime;
            
            if (deltaTime >= frameDelay) {
                // ë°°ê²½ê³¼ í™˜ê²½ ê·¸ë¦¬ê¸°
                drawEnvironment();
                
                if (gameState === 'playing') {
                    // ê²Œì„ ë¡œì§ ì—…ë°ì´íŠ¸
                    updateCharacter();
                    updateBombs();
                    updateBonusItems();
                    updateInvulnerability(deltaTime);
                    
                    // ì¶©ëŒ ê°ì§€
                    checkBombCollisions();
                    checkBonusItemCollisions();
                    
                    // ê²Œì„ ìš”ì†Œ ê·¸ë¦¬ê¸°
                    drawBombs();
                    drawBonusItems();
                    drawCharacter();
                }
                
                lastTime = currentTime;
            }
            requestAnimationFrame(gameLoop);
        }

        // ìƒìœ„ 10ìœ„ í™•ì¸ ëª¨ë‹¬ í•¨ìˆ˜ë“¤
        async function checkTop10Eligibility(newScore) {
            if (!window.firebaseDB) return false;
            
            try {
                const { collection, query, orderBy, limit, getDocs } = window.firestoreModules;
                const q = query(
                    collection(window.firebaseDB, 'dodger_rankings'), // dodger ì „ìš© ë­í‚¹
                    orderBy('score', 'desc'),
                    limit(10)
                );
                
                const snapshot = await getDocs(q);
                const rankings = [];
                snapshot.forEach((doc) => {
                    rankings.push(doc.data());
                });
                
                return rankings.length < 10 || newScore > (rankings[rankings.length - 1]?.score || 0);
                
            } catch (error) {
                console.error('ìˆœìœ„ í™•ì¸ ì˜¤ë¥˜:', error);
                return false;
            }
        }

        function showRankCheckModal() {
            const message = `ì¶•í•˜í•©ë‹ˆë‹¤! ${score}ì ìœ¼ë¡œ ìƒìœ„ 10ìœ„ì— ì§„ì…í–ˆìŠµë‹ˆë‹¤!<br>ë­í‚¹ì— ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            document.getElementById('rankCheckMessage').innerHTML = message;
            document.getElementById('rankCheckModal').classList.remove('hidden');
        }

        function proceedToRankingRegistration() {
            document.getElementById('rankCheckModal').classList.add('hidden');
            document.getElementById('nameInputSection').classList.remove('hidden');
            document.getElementById('gameEndButtons').classList.add('hidden');
            clearGameOverInputs();
            document.getElementById('gameOverScreen').classList.remove('hidden');
        }

        function skipRankingRegistration() {
            document.getElementById('rankCheckModal').classList.add('hidden');
            document.getElementById('nameInputSection').classList.add('hidden');
            document.getElementById('gameEndButtons').classList.remove('hidden');
            clearGameOverInputs();
            document.getElementById('gameOverScreen').classList.remove('hidden');
        }

        // Firebase ë­í‚¹ í•¨ìˆ˜ë“¤ (dodger ì „ìš©)
        async function submitScore() {
            const nickname = document.getElementById('playerName').value.trim();
            const pin = document.getElementById('playerPin').value.trim();
            const messageEl = document.getElementById('submitMessage');
            
            if (!nickname) {
                messageEl.innerHTML = '<div class="error-message">ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!</div>';
                return;
            }
            
            if (!pin || pin.length !== 6) {
                messageEl.innerHTML = '<div class="error-message">ê°œì¸í™•ì¸ë²ˆí˜¸ëŠ” 6ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤!</div>';
                return;
            }
            
            if (!window.firebaseDB) {
                messageEl.innerHTML = '<div class="error-message">Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤!</div>';
                return;
            }
            
            try {
                messageEl.innerHTML = '<div class="loading">ë­í‚¹ ë“±ë¡ ì¤‘...</div>';
                
                const { collection, addDoc } = window.firestoreModules;
                const rankingData = {
                    nickname: nickname,
                    pin: simpleHash(pin),
                    rawPin: pin,
                    score: score,
                    timestamp: Date.now(),
                    date: new Date().toLocaleDateString('ko-KR'),
                    device: isMobile ? 'mobile' : 'desktop'
                };
                
                await addDoc(collection(window.firebaseDB, 'dodger_rankings'), rankingData); // dodger ì „ìš© ì»¬ë ‰ì…˜
                
                // ì‹ ê¸°ë¡ í™•ì¸ ë° ì—…ë°ì´íŠ¸
                if (score > allTimeRecord.score) {
                    await updateAllTimeRecord(score, nickname, isMobile ? 'mobile' : 'desktop');
                }
                
                messageEl.innerHTML = '<div class="success-message">ë­í‚¹ ë“±ë¡ ì™„ë£Œ!</div>';
                document.getElementById('nameInputSection').classList.add('hidden');
                document.getElementById('gameEndButtons').classList.remove('hidden');
                loadTop3Rankings();
                
                clearGameOverInputs();
                
            } catch (error) {
                console.error('ë­í‚¹ ë“±ë¡ ì˜¤ë¥˜:', error);
                messageEl.innerHTML = '<div class="error-message">ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message + '</div>';
            }
        }

        async function loadTop3Rankings() {
            if (!window.firebaseDB) {
                document.getElementById('top3Rankings').innerHTML = 'Firebase ì—°ê²° í•„ìš”';
                return;
            }
            
            try {
                const { collection, query, orderBy, limit, onSnapshot } = window.firestoreModules;
                const q = query(
                    collection(window.firebaseDB, 'dodger_rankings'), // dodger ì „ìš© ë­í‚¹
                    orderBy('score', 'desc'),
                    limit(3)
                );
                
                onSnapshot(q, (snapshot) => {
                    const rankings = [];
                    snapshot.forEach((doc) => {
                        rankings.push(doc.data());
                    });
                    displayTop3Rankings(rankings);
                });
                
            } catch (error) {
                console.error('ë­í‚¹ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('top3Rankings').innerHTML = 'ë¡œë”© ì‹¤íŒ¨: ' + error.message;
            }
        }

        function displayTop3Rankings(rankings) {
            const container = document.getElementById('top3Rankings');
            
            if (rankings.length === 0) {
                container.innerHTML = '<p>ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }
            
            let html = '';
            rankings.forEach((player, index) => {
                const medal = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][index];
                const deviceIcon = player.device === 'mobile' ? 'ğŸ“±' : 'ğŸ’»';
                html += `<div class="rank-item top3">
                    <span>${medal} ${index + 1}ìœ„. ${player.nickname} ${deviceIcon}</span>
                    <span>${player.score}ì </span>
                </div>`;
            });
            
            container.innerHTML = html;
        }

        async function checkMyRanking() {
            const nickname = document.getElementById('checkNickname').value.trim();
            const pin = document.getElementById('checkPin').value.trim();
            const displayEl = document.getElementById('myRankDisplay');
            
            // ê´€ë¦¬ì ë¡œê·¸ì¸ í™•ì¸
            if (nickname === 'mildersboss' && pin === '021502') {
                await adminLogin();
                document.getElementById('checkNickname').value = '';
                document.getElementById('checkPin').value = '';
                return;
            }
            
            if (!nickname || !pin) {
                displayEl.innerHTML = '<div class="error-message">ë‹‰ë„¤ì„ê³¼ ê°œì¸í™•ì¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>';
                return;
            }
            
            if (!window.firebaseDB) {
                displayEl.innerHTML = '<div class="error-message">Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤</div>';
                return;
            }
            
            try {
                displayEl.innerHTML = '<div class="loading">ê²€ìƒ‰ ì¤‘...</div>';
                
                const { collection, query, where, getDocs, orderBy } = window.firestoreModules;
                
                const q = query(
                    collection(window.firebaseDB, 'dodger_rankings'), // dodger ì „ìš© ë­í‚¹
                    where('nickname', '==', nickname),
                    where('rawPin', '==', pin)
                );
                
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    displayEl.innerHTML = '<div class="error-message">ì¼ì¹˜í•˜ëŠ” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                    return;
                }
                
                const allRankingsQuery = query(
                    collection(window.firebaseDB, 'dodger_rankings'),
                    orderBy('score', 'desc')
                );
                
                const allSnapshot = await getDocs(allRankingsQuery);
                const allRankings = [];
                allSnapshot.forEach((doc) => {
                    allRankings.push(doc.data());
                });
                
                const myRecords = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const rank = allRankings.findIndex(r => r.timestamp === data.timestamp) + 1;
                    myRecords.push({ ...data, rank });
                });
                
                myRecords.sort((a, b) => a.rank - b.rank);
                const bestRecord = myRecords[0];
                const deviceIcon = bestRecord.device === 'mobile' ? 'ğŸ“±' : 'ğŸ’»';
                
                displayEl.innerHTML = `
                    <div class="success-message">
                        ìµœê³  ìˆœìœ„: ${bestRecord.rank}ìœ„ ${deviceIcon}<br>
                        ì ìˆ˜: ${bestRecord.score}ì <br>
                        ë‚ ì§œ: ${bestRecord.date}
                    </div>
                `;
                
            } catch (error) {
                console.error('ìˆœìœ„ í™•ì¸ ì˜¤ë¥˜:', error);
                displayEl.innerHTML = '<div class="error-message">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message + '</div>';
            }
        }

        // ì´ˆê¸°í™” ë° ê²Œì„ ì‹œì‘
        console.log(`Martin Bomb Dodger ì¤€ë¹„ ì™„ë£Œ! (${isMobile ? 'ëª¨ë°”ì¼' : 'ë°ìŠ¤í¬íƒ‘'})`);

        setTimeout(() => {
            if (window.firebaseDB) {
                loadTop3Rankings();
                loadAllTimeRecord();
                updateConnectionStatus('online', isMobile ? 'ëª¨ë°”ì¼ ì—°ê²°' : 'ë°ìŠ¤í¬íƒ‘ ì—°ê²°');
                loadNotices();
                updateVisitorCount();
                loadVisitorCount();
            } else {
                updateConnectionStatus('offline', 'Firebase ì˜¤ë¥˜');
                document.getElementById('top3Rankings').innerHTML = `
                    <p style="color: #f44336;">Firebase ì—°ê²° ì˜¤ë¥˜</p>
                    <p style="font-size: 12px;">ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”</p>
                `;
                document.getElementById('allTimeRecord').textContent = 'ğŸ† ì—­ëŒ€ ìµœê³  ê¸°ë¡: ì—°ê²° ì˜¤ë¥˜';
            }
        }, 1000);

        gameLoop();
    </script>
</body>
</html>