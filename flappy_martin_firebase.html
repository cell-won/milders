<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì¼ë”ìŠ¤ í”Œë˜í”¼ ë§ˆí‹´</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #87CEEB;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
        }

        #gameContainer {
            position: relative;
            border: 3px solid #333;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            #gameContainer {
                transform: scale(0.8);
                border: 2px solid #333;
            }
            
            .ui-overlay {
                font-size: 18px !important;
            }
            
            .game-title {
                font-size: 28px !important;
            }
            
            button {
                padding: 12px 24px !important;
                font-size: 16px !important;
            }
            
            input {
                font-size: 16px !important;
                padding: 8px !important;
            }
            
            #rankingSection {
                flex-direction: column !important;
                gap: 15px !important;
            }
            
            #rankingList, #rankingControls {
                max-width: 280px !important;
            }
        }

        @media (max-width: 480px) {
            #gameContainer {
                transform: scale(0.7);
            }
            
            .game-title {
                font-size: 24px !important;
            }
        }

        #gameCanvas {
            display: block;
            cursor: pointer;
        }

        .ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: 24px;
            text-align: center;
            z-index: 100;
        }

        .hidden {
            display: none !important;
        }

        button {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 18px;
            margin: 10px;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        button.secondary {
            background: #2196F3;
        }

        button.secondary:hover {
            background: #1976D2;
        }

        #rankingSection {
            display: flex;
            gap: 30px;
            align-items: flex-start;
            justify-content: center;
        }

        #rankingList {
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 20px;
            border-radius: 10px;
            max-width: 300px;
            min-width: 250px;
        }

        #rankingControls {
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 20px;
            border-radius: 10px;
            max-width: 250px;
        }

        .rank-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
        }

        .rank-item.top3 {
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            color: #333;
        }

        #score {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 32px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 10;
        }

        input[type="text"], input[type="password"], input[type="number"] {
            padding: 10px;
            font-size: 18px;
            border: 2px solid #ccc;
            border-radius: 5px;
            margin: 5px;
            width: 200px;
        }

        #startButtonImage {
            cursor: pointer;
            transition: transform 0.2s;
            max-width: 200px;
            margin: 20px;
        }

        #startButtonImage:hover {
            transform: scale(1.1);
        }

        .game-title {
            font-size: 36px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            margin-bottom: 30px;
        }

        #connectionStatus {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }

        .online {
            background: #4CAF50;
            color: white;
        }

        .offline {
            background: #f44336;
            color: white;
        }

        .loading {
            background: #ff9800;
            color: white;
        }

        .error-message {
            color: #f44336;
            font-size: 14px;
            margin: 10px 0;
        }

        .success-message {
            color: #4CAF50;
            font-size: 14px;
            margin: 10px 0;
        }

        #myRankResult {
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="900" height="700"></canvas>
        
        <!-- ì—°ê²° ìƒíƒœ í‘œì‹œ -->
        <div id="connectionStatus" class="loading">ğŸ”„ ì—°ê²° ì¤‘...</div>
        
        <!-- ì ìˆ˜ í‘œì‹œ -->
        <div id="score">ì ìˆ˜: 0</div>
        
        <!-- ì‹œì‘ í™”ë©´ -->
        <div id="startScreen" class="ui-overlay">
            <h1 class="game-title">ë§ˆì¼ë”ìŠ¤ í”Œë˜í”¼ ë§ˆí‹´</h1>
            <p>ìŠ¤í˜ì´ìŠ¤ë°” ë˜ëŠ” í´ë¦­ìœ¼ë¡œ ì í”„í•˜ì„¸ìš”!</p>
            <img id="startButtonImage" src="startbutton.png" alt="ê²Œì„ ì‹œì‘" onclick="startGame()">
            
            <div id="rankingSection">
                <div id="rankingList">
                    <h3>ğŸ† TOP 3 ë­í‚¹</h3>
                    <div id="top3Rankings">ë¡œë”© ì¤‘...</div>
                </div>
                
                <div id="rankingControls">
                    <h3>ğŸ” ë‚´ ìˆœìœ„ í™•ì¸</h3>
                    <input type="text" id="checkNickname" placeholder="ë‹‰ë„¤ì„" maxlength="10">
                    <input type="password" id="checkPin" placeholder="ê°œì¸í™•ì¸ë²ˆí˜¸" maxlength="6">
                    <br>
                    <button class="secondary" onclick="checkMyRanking()">ë‚´ ìˆœìœ„ ë³´ê¸°</button>
                    <div id="myRankDisplay"></div>
                </div>
            </div>
        </div>
        
        <!-- ê²Œì„ì˜¤ë²„ í™”ë©´ -->
        <div id="gameOverScreen" class="ui-overlay hidden">
            <img src="gameover.png" alt="ê²Œì„ ì˜¤ë²„" style="max-width: 300px; margin: 20px;">
            <p id="finalScore">ìµœì¢… ì ìˆ˜: 0</p>
            <div id="nameInputSection" class="hidden">
                <p>ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ìƒìœ„ 20ìœ„ ì§„ì…!</p>
                <input type="text" id="playerName" placeholder="ë‹‰ë„¤ì„ (ê³µê°œ)" maxlength="10">
                <input type="number" id="playerPin" placeholder="ê°œì¸í™•ì¸ë²ˆí˜¸ (ë¹„ê³µê°œ)" maxlength="6" min="100000" max="999999">
                <p style="font-size: 14px; color: #ccc;">* ê°œì¸í™•ì¸ë²ˆí˜¸ëŠ” 6ìë¦¬ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”</p>
                <br>
                <button onclick="submitScore()">ë­í‚¹ ë“±ë¡</button>
                <div id="submitMessage"></div>
            </div>
            <button onclick="restartGame()">ë‹¤ì‹œ ì‹œì‘</button>
            <button onclick="showStartScreen()">ë©”ì¸ ë©”ë‰´</button>
        </div>
        
        <!-- ë‚´ ìˆœìœ„ ìƒì„¸ í™”ë©´ -->
        <div id="myRankDetailScreen" class="ui-overlay hidden">
            <h2>ğŸ“Š ë‚´ ìˆœìœ„ ìƒì„¸</h2>
            <div id="myRankResult"></div>
            <button onclick="closeMyRankDetail()">ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // âš ï¸ ì—¬ê¸°ì— Firebase ì„¤ì •ì„ ì…ë ¥í•˜ì„¸ìš”!
        // Firebase ì½˜ì†”ì—ì„œ ë³µì‚¬í•œ ì„¤ì • ì½”ë“œë¥¼ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // ğŸ”¥ Firebase ì„¤ì • (ì—¬ëŸ¬ë¶„ì˜ ì„¤ì •ìœ¼ë¡œ êµì²´ ì™„ë£Œ!)
        const firebaseConfig = {
            apiKey: "AIzaSyBHUAQuZ-JeNmpeDfdbo5kPwW7v2emH8bg",
            authDomain: "milders-flappy-martin.firebaseapp.com",
            projectId: "milders-flappy-martin",
            storageBucket: "milders-flappy-martin.firebasestorage.app",
            messagingSenderId: "505347834080",
            appId: "1:505347834080:web:c10bcf079e1681ffd19085"
        };

        // Firebase ì´ˆê¸°í™”
        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            updateConnectionStatus('online', 'ğŸŒ ì‹¤ì‹œê°„ ì—°ê²°');
            console.log("ğŸ”¥ Firebase ì—°ê²° ì„±ê³µ!");
        } catch (error) {
            console.error("âŒ Firebase ì„¤ì • ì˜¤ë¥˜:", error);
            updateConnectionStatus('offline', 'âŒ ì˜¤í”„ë¼ì¸');
            db = null;
        }

        // ì „ì—­ ë³€ìˆ˜ë¡œ ì„¤ì • (ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‚¬ìš©)
        window.firebaseDB = db;
        window.firestoreModules = { collection, addDoc, query, orderBy, limit, onSnapshot, where, getDocs };
    </script>

    <script>
        // ê²Œì„ ê¸°ë³¸ ì„¤ì •
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let gameState = 'start';
        let score = 0;
        let gameSpeed = 2.2;
        let difficultyLevel = 1;
        
        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(status, text) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = status;
            statusEl.textContent = text;
        }
        
        // ì´ë¯¸ì§€ ê°ì²´ë“¤
        const gameImages = {
            background: null,
            character: null,
            blockTop: null,
            blockBottom: null,
            ground: null,
            loaded: {
                background: false,
                character: false,
                blockTop: false,
                blockBottom: false,
                ground: false
            }
        };
        
        // ë°”ë‹¥ ì„¤ì •
        const GROUND_HEIGHT = 80;
        
        // ì•ˆì „í•œ ì´ë¯¸ì§€ ë¡œë”© í•¨ìˆ˜
        function loadGameImage(key, filename) {
            const img = new Image();
            img.onload = function() {
                gameImages[key] = img;
                gameImages.loaded[key] = true;
                console.log(`âœ… ${filename} ë¡œë”© ì„±ê³µ`);
            };
            img.onerror = function() {
                console.log(`âš ï¸ ${filename} ë¡œë”© ì‹¤íŒ¨ - ê¸°ë³¸ ê·¸ë˜í”½ ì‚¬ìš©`);
                gameImages.loaded[key] = false;
            };
            img.src = filename;
        }
        
        // ì´ë¯¸ì§€ íŒŒì¼ë“¤ ë¡œë”© ì‹œì‘
        loadGameImage('background', 'background.png');
        loadGameImage('character', 'martin.png');
        loadGameImage('blockTop', 'blocktop.png');
        loadGameImage('blockBottom', 'blockbottom.png');
        loadGameImage('ground', 'ground.png');
        
        // ìºë¦­í„° ì„¤ì •
        const bird = {
            x: 120,
            y: 350,
            width: 40,
            height: 40,
            velocity: 0,
            rotation: 0
        };
        
        // ê²Œì„ ë¬¼ë¦¬ ìƒìˆ˜
        const GRAVITY = 0.4;
        const JUMP_POWER = -7.0;
        const MAX_VELOCITY = 10;
        const MIN_VELOCITY = -10;
        
        // ê²Œì„ ìš”ì†Œë“¤
        let obstacles = [];
        let obstacleTimer = 0;
        let obstacleInterval = 140;
        let backgroundScroll = 0;
        
        // ğŸ”¥ Firebase ì‹¤ì‹œê°„ ë­í‚¹ ì‹œìŠ¤í…œ
        
        // ì•”í˜¸í™” í•¨ìˆ˜ (ê°„ë‹¨í•œ í•´ì‹œ)
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // 32bit integer ë³€í™˜
            }
            return Math.abs(hash).toString().slice(0, 6);
        }
        
        // ì ìˆ˜ ì œì¶œ (Firebase)
        async function submitScore() {
            const nickname = document.getElementById('playerName').value.trim();
            const pin = document.getElementById('playerPin').value.trim();
            const messageEl = document.getElementById('submitMessage');
            
            if (!nickname) {
                messageEl.innerHTML = '<div class="error-message">ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!</div>';
                return;
            }
            
            if (!pin || pin.length !== 6) {
                messageEl.innerHTML = '<div class="error-message">ê°œì¸í™•ì¸ë²ˆí˜¸ëŠ” 6ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤!</div>';
                return;
            }
            
            if (!window.firebaseDB) {
                messageEl.innerHTML = '<div class="error-message">Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤!</div>';
                return;
            }
            
            try {
                messageEl.innerHTML = '<div class="loading">ë­í‚¹ ë“±ë¡ ì¤‘...</div>';
                
                const { collection, addDoc } = window.firestoreModules;
                const rankingData = {
                    nickname: nickname,
                    pin: simpleHash(pin), // ì•”í˜¸í™”ëœ PIN
                    rawPin: pin, // ì„ì‹œë¡œ ì›ë³¸ë„ ì €ì¥ (ì‹¤ì œë¡œëŠ” ì•”í˜¸í™”ë§Œ ì €ì¥)
                    score: score,
                    timestamp: Date.now(),
                    date: new Date().toLocaleDateString('ko-KR')
                };
                
                await addDoc(collection(window.firebaseDB, 'rankings'), rankingData);
                
                messageEl.innerHTML = '<div class="success-message">ğŸ‰ ë­í‚¹ ë“±ë¡ ì™„ë£Œ!</div>';
                document.getElementById('nameInputSection').classList.add('hidden');
                
                // ë­í‚¹ ìƒˆë¡œê³ ì¹¨
                loadTop3Rankings();
                
            } catch (error) {
                console.error('ë­í‚¹ ë“±ë¡ ì˜¤ë¥˜:', error);
                messageEl.innerHTML = '<div class="error-message">ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }
        
        // TOP 3 ë­í‚¹ ë¡œë“œ
        async function loadTop3Rankings() {
            if (!window.firebaseDB) {
                document.getElementById('top3Rankings').innerHTML = 'âŒ Firebase ì—°ê²° í•„ìš”';
                return;
            }
            
            try {
                const { collection, query, orderBy, limit, onSnapshot } = window.firestoreModules;
                const q = query(
                    collection(window.firebaseDB, 'rankings'),
                    orderBy('score', 'desc'),
                    limit(3)
                );
                
                // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì„¤ì •
                onSnapshot(q, (snapshot) => {
                    const rankings = [];
                    snapshot.forEach((doc) => {
                        rankings.push(doc.data());
                    });
                    
                    displayTop3Rankings(rankings);
                });
                
            } catch (error) {
                console.error('ë­í‚¹ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('top3Rankings').innerHTML = 'âŒ ë¡œë”© ì‹¤íŒ¨';
            }
        }
        
        // TOP 3 ë­í‚¹ í‘œì‹œ
        function displayTop3Rankings(rankings) {
            const container = document.getElementById('top3Rankings');
            
            if (rankings.length === 0) {
                container.innerHTML = '<p>ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }
            
            let html = '';
            rankings.forEach((player, index) => {
                const medal = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][index];
                html += `<div class="rank-item top3">
                    <span>${medal} ${index + 1}ìœ„. ${player.nickname}</span>
                    <span>${player.score}ì </span>
                </div>`;
            });
            
            container.innerHTML = html;
        }
        
        // ë‚´ ìˆœìœ„ í™•ì¸
        async function checkMyRanking() {
            const nickname = document.getElementById('checkNickname').value.trim();
            const pin = document.getElementById('checkPin').value.trim();
            const displayEl = document.getElementById('myRankDisplay');
            
            if (!nickname || !pin) {
                displayEl.innerHTML = '<div class="error-message">ë‹‰ë„¤ì„ê³¼ ê°œì¸í™•ì¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>';
                return;
            }
            
            if (!window.firebaseDB) {
                displayEl.innerHTML = '<div class="error-message">Firebase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤</div>';
                return;
            }
            
            try {
                displayEl.innerHTML = '<div class="loading">ê²€ìƒ‰ ì¤‘...</div>';
                
                const { collection, query, where, getDocs, orderBy } = window.firestoreModules;
                
                // í•´ë‹¹ ë‹‰ë„¤ì„ì˜ ëª¨ë“  ê¸°ë¡ ê²€ìƒ‰
                const q = query(
                    collection(window.firebaseDB, 'rankings'),
                    where('nickname', '==', nickname),
                    where('rawPin', '==', pin)
                );
                
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    displayEl.innerHTML = '<div class="error-message">ì¼ì¹˜í•˜ëŠ” ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                    return;
                }
                
                // ì „ì²´ ë­í‚¹ì—ì„œ ìˆœìœ„ ê³„ì‚°
                const allRankingsQuery = query(
                    collection(window.firebaseDB, 'rankings'),
                    orderBy('score', 'desc')
                );
                
                const allSnapshot = await getDocs(allRankingsQuery);
                const allRankings = [];
                allSnapshot.forEach((doc) => {
                    allRankings.push(doc.data());
                });
                
                // ë‚´ ê¸°ë¡ë“¤ ì°¾ê¸°
                const myRecords = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const rank = allRankings.findIndex(r => r.timestamp === data.timestamp) + 1;
                    myRecords.push({ ...data, rank });
                });
                
                // ìµœê³  ê¸°ë¡ í‘œì‹œ
                myRecords.sort((a, b) => a.rank - b.rank);
                const bestRecord = myRecords[0];
                
                displayEl.innerHTML = `
                    <div class="success-message">
                        ğŸ† ìµœê³  ìˆœìœ„: ${bestRecord.rank}ìœ„<br>
                        ğŸ“Š ì ìˆ˜: ${bestRecord.score}ì <br>
                        ğŸ“… ë‚ ì§œ: ${bestRecord.date}
                    </div>
                `;
                
            } catch (error) {
                console.error('ìˆœìœ„ í™•ì¸ ì˜¤ë¥˜:', error);
                displayEl.innerHTML = '<div class="error-message">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
            }
        }
        
        // 20ìœ„ ë‚´ í™•ì¸
        async function checkTop20Eligibility(newScore) {
            if (!window.firebaseDB) return false;
            
            try {
                const { collection, query, orderBy, limit, getDocs } = window.firestoreModules;
                const q = query(
                    collection(window.firebaseDB, 'rankings'),
                    orderBy('score', 'desc'),
                    limit(20)
                );
                
                const snapshot = await getDocs(q);
                const rankings = [];
                snapshot.forEach((doc) => {
                    rankings.push(doc.data());
                });
                
                // 20ìœ„ë³´ë‹¤ ì ê±°ë‚˜, 20ìœ„ ì ìˆ˜ë³´ë‹¤ ë†’ìœ¼ë©´ ë“±ë¡ ê°€ëŠ¥
                return rankings.length < 20 || newScore > rankings[rankings.length - 1].score;
                
            } catch (error) {
                console.error('ìˆœìœ„ í™•ì¸ ì˜¤ë¥˜:', error);
                return false;
            }
        }
        
        // ìºë¦­í„° ê·¸ë¦¬ê¸°
        function drawBird() {
            ctx.save();
            ctx.translate(bird.x + bird.width/2, bird.y + bird.height/2);
            ctx.rotate(bird.rotation);
            
            if (gameImages.loaded.character && gameImages.character) {
                ctx.drawImage(
                    gameImages.character,
                    -bird.width/2, -bird.height/2,
                    bird.width, bird.height
                );
            } else {
                // ê¸°ë³¸ ìºë¦­í„° (ì˜¤ë Œì§€ ì›)
                ctx.fillStyle = '#FF6B35';
                ctx.beginPath();
                ctx.arc(0, 0, bird.width/2, 0, Math.PI * 2);
                ctx.fill();
                
                // ëˆˆ ê·¸ë¦¬ê¸°
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(-8, -8, 6, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.arc(-8, -8, 3, 0, Math.PI * 2);
                ctx.fill();
            }
            
            ctx.restore();
        }
        
        // ë°°ê²½+ë°”ë‹¥ ê·¸ë¦¬ê¸°
        function drawEnvironment() {
            // ë°°ê²½ ê·¸ë¦¬ê¸°
            if (gameImages.loaded.background && gameImages.background) {
                const bgMove = backgroundScroll * 0.3;
                const bgOffset = bgMove % canvas.width;
                const bgX1 = -bgOffset;
                const bgX2 = bgX1 + canvas.width;
                
                ctx.drawImage(gameImages.background, bgX1, 0, canvas.width, canvas.height);
                ctx.drawImage(gameImages.background, bgX2, 0, canvas.width, canvas.height);
                
            } else {
                // ê¸°ë³¸ ë°°ê²½
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height - GROUND_HEIGHT);
                gradient.addColorStop(0, '#87CEEB');
                gradient.addColorStop(1, '#98FB98');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height - GROUND_HEIGHT);
                
                // êµ¬ë¦„ë“¤
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                const cloudMove = backgroundScroll * 0.15;
                for(let i = 0; i < 10; i++) {
                    const cloudX = (cloudMove + i * 150) % (canvas.width + 100) - 50;
                    drawCloud(cloudX, 60 + (i % 3) * 50);
                }
            }
            
            // ë°”ë‹¥ ê·¸ë¦¬ê¸°
            const groundY = canvas.height - GROUND_HEIGHT;
            
            if (gameImages.loaded.ground && gameImages.ground) {
                const groundMove = backgroundScroll * 0.3;
                const groundOffset = groundMove % canvas.width;
                const groundX1 = -groundOffset;
                const groundX2 = groundX1 + canvas.width;
                
                ctx.drawImage(gameImages.ground, groundX1, groundY, canvas.width, GROUND_HEIGHT);
                ctx.drawImage(gameImages.ground, groundX2, groundY, canvas.width, GROUND_HEIGHT);
            } else {
                ctx.fillStyle = '#90EE90';
                ctx.fillRect(0, groundY, canvas.width, GROUND_HEIGHT);
                
                ctx.strokeStyle = '#228B22';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(0, groundY);
                ctx.lineTo(canvas.width, groundY);
                ctx.stroke();
            }
        }
        
        // êµ¬ë¦„ ê·¸ë¦¬ê¸°
        function drawCloud(x, y) {
            ctx.beginPath();
            ctx.arc(x, y, 20, 0, Math.PI * 2);
            ctx.arc(x + 25, y, 25, 0, Math.PI * 2);
            ctx.arc(x + 50, y, 20, 0, Math.PI * 2);
            ctx.arc(x + 25, y - 15, 20, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // ì¥ì• ë¬¼ ìƒì„±
        function createObstacle() {
            const gap = Math.max(120, 180 - (difficultyLevel * 8));
            const minHeight = 60;
            const maxHeight = canvas.height - gap - GROUND_HEIGHT - 60;
            const topHeight = minHeight + Math.random() * (maxHeight - minHeight);
            
            obstacles.push({
                x: canvas.width,
                topHeight: topHeight,
                bottomY: topHeight + gap,
                bottomHeight: canvas.height - (topHeight + gap) - GROUND_HEIGHT,
                width: 50,
                passed: false
            });
        }
        
        // ì¥ì• ë¬¼ ê·¸ë¦¬ê¸°
        function drawObstacles() {
            obstacles.forEach(obstacle => {
                // ìƒë‹¨ ì¥ì• ë¬¼
                if (gameImages.loaded.blockTop && gameImages.blockTop) {
                    ctx.drawImage(
                        gameImages.blockTop,
                        obstacle.x, 0, 
                        obstacle.width, obstacle.topHeight
                    );
                } else {
                    ctx.fillStyle = '#228B22';
                    ctx.fillRect(obstacle.x, 0, obstacle.width, obstacle.topHeight);
                    ctx.strokeStyle = '#006400';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(obstacle.x, 0, obstacle.width, obstacle.topHeight);
                }
                
                // í•˜ë‹¨ ì¥ì• ë¬¼
                if (gameImages.loaded.blockBottom && gameImages.blockBottom) {
                    ctx.drawImage(
                        gameImages.blockBottom,
                        obstacle.x, obstacle.bottomY,
                        obstacle.width, obstacle.bottomHeight
                    );
                } else {
                    ctx.fillStyle = '#228B22';
                    ctx.fillRect(obstacle.x, obstacle.bottomY, obstacle.width, obstacle.bottomHeight);
                    ctx.strokeStyle = '#006400';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(obstacle.x, obstacle.bottomY, obstacle.width, obstacle.bottomHeight);
                }
            });
        }
        
        // ìºë¦­í„° ì—…ë°ì´íŠ¸
        function updateBird() {
            bird.velocity += GRAVITY;
            bird.velocity = Math.max(MIN_VELOCITY, Math.min(MAX_VELOCITY, bird.velocity));
            bird.y += bird.velocity;
            bird.rotation = Math.min(bird.velocity * 0.06, Math.PI / 4);
            
            if (bird.y <= 0) {
                bird.y = 0;
                bird.velocity = 0;
            }
            
            if (bird.y + bird.height >= canvas.height - GROUND_HEIGHT) {
                gameOver();
            }
        }
        
        // ì¥ì• ë¬¼ ì—…ë°ì´íŠ¸
        function updateObstacles() {
            obstacles.forEach(obstacle => {
                obstacle.x -= gameSpeed;
                
                if (!obstacle.passed && obstacle.x + obstacle.width < bird.x) {
                    obstacle.passed = true;
                    score++;
                    updateScore();
                    
                    if (score % 5 === 0) {
                        difficultyLevel++;
                        gameSpeed += 0.15;
                        obstacleInterval = Math.max(80, obstacleInterval - 3);
                    }
                }
            });
            
            obstacles = obstacles.filter(obstacle => obstacle.x > -obstacle.width);
            
            obstacleTimer++;
            if (obstacleTimer >= obstacleInterval) {
                createObstacle();
                obstacleTimer = 0;
            }
        }
        
        // ì¶©ëŒ ê°ì§€
        function checkCollisions() {
            const birdLeft = bird.x + 2;
            const birdRight = bird.x + bird.width - 2;
            const birdTop = bird.y + 2;
            const birdBottom = bird.y + bird.height - 2;
            
            obstacles.forEach(obstacle => {
                if (birdRight > obstacle.x && birdLeft < obstacle.x + obstacle.width) {
                    if (birdTop < obstacle.topHeight || birdBottom > obstacle.bottomY) {
                        gameOver();
                    }
                }
            });
        }
        
        // ì í”„ í•¨ìˆ˜
        function jump() {
            if (gameState === 'playing') {
                bird.velocity = JUMP_POWER;
                console.log("ğŸš€ ì í”„!");
            }
        }
        
        // ì ìˆ˜ ì—…ë°ì´íŠ¸
        function updateScore() {
            document.getElementById('score').textContent = `ì ìˆ˜: ${score}`;
        }
        
        // ê²Œì„ ë£¨í”„
        function gameLoop() {
            drawEnvironment();
            
            if (gameState === 'playing') {
                backgroundScroll += gameSpeed * 0.5;
                updateBird();
                updateObstacles();
                checkCollisions();
                drawObstacles();
                drawBird();
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        // ê²Œì„ ì‹œì‘
        function startGame() {
            console.log("ğŸ® ë§ˆì¼ë”ìŠ¤ í”Œë˜í”¼ ë§ˆí‹´ ê²Œì„ ì‹œì‘!");
            gameState = 'playing';
            score = 0;
            gameSpeed = 2.2;
            difficultyLevel = 1;
            obstacleInterval = 140;
            
            bird.x = 120;
            bird.y = 350;
            bird.velocity = 0;
            bird.rotation = 0;
            
            obstacles = [];
            obstacleTimer = 0;
            backgroundScroll = 0;
            
            updateScore();
            
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('myRankDetailScreen').classList.add('hidden');
        }
        
        // ê²Œì„ ì˜¤ë²„
        async function gameOver() {
            gameState = 'gameOver';
            document.getElementById('finalScore').textContent = `ìµœì¢… ì ìˆ˜: ${score}`;
            
            // 20ìœ„ ë‚´ ì§„ì… í™•ì¸
            const isTop20 = await checkTop20Eligibility(score);
            
            if (isTop20) {
                document.getElementById('nameInputSection').classList.remove('hidden');
            } else {
                document.getElementById('nameInputSection').classList.add('hidden');
            }
            
            document.getElementById('gameOverScreen').classList.remove('hidden');
        }
        
        function restartGame() {
            startGame();
        }
        
        function showStartScreen() {
            gameState = 'start';
            document.getElementById('startScreen').classList.remove('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('myRankDetailScreen').classList.add('hidden');
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('checkNickname').value = '';
            document.getElementById('checkPin').value = '';
            document.getElementById('myRankDisplay').innerHTML = '';
        }
        
        function closeMyRankDetail() {
            document.getElementById('myRankDetailScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
        }
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                jump();
            }
        });
        
        canvas.addEventListener('click', jump);
        
        // í„°ì¹˜ ì´ë²¤íŠ¸ ì¶”ê°€ (ëª¨ë°”ì¼ ì§€ì›)
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            jump();
        });
        
        // Enter í‚¤ ì´ë²¤íŠ¸
        document.getElementById('checkNickname').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('checkPin').focus();
            }
        });
        
        document.getElementById('checkPin').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                checkMyRanking();
            }
        });
        
        document.getElementById('playerName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('playerPin').focus();
            }
        });
        
        document.getElementById('playerPin').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitScore();
            }
        });
        
        // ê²Œì„ ì´ˆê¸°í™”
        console.log("ğŸ¯ ë§ˆì¼ë”ìŠ¤ í”Œë˜í”¼ ë§ˆí‹´ Firebase ë²„ì „ ì¤€ë¹„ ì™„ë£Œ!");
        
        // Firebase ì—°ê²° í™•ì¸ í›„ ë­í‚¹ ë¡œë“œ
        setTimeout(() => {
            if (window.firebaseDB) {
                loadTop3Rankings();
                updateConnectionStatus('online', 'ğŸŒ ì‹¤ì‹œê°„ ì—°ê²°');
            } else {
                updateConnectionStatus('offline', 'âŒ Firebase ì„¤ì • í•„ìš”');
                document.getElementById('top3Rankings').innerHTML = `
                    <p style="color: #f44336;">Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                    <p style="font-size: 12px;">ì„¤ì • ë°©ë²•ì€ ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.</p>
                `;
            }
        }, 1000);
        
        gameLoop();
    </script>
</body>
</html>